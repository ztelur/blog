<!DOCTYPE html>
<html lang="Ch">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    
    <title>程序员历小冰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta property="og:type" content="website">
<meta property="og:title" content="程序员历小冰">
<meta property="og:url" content="http://remcarpediem.net/page/7/index.html">
<meta property="og:site_name" content="程序员历小冰">
<meta property="og:locale" content="Chinese">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="程序员历小冰">
    

    
        <link rel="alternate" href="/atom.xml" title="程序员历小冰" type="application/atom+xml">
    

    
        <link rel="icon" href="/css/images/avatar.jpeg">
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
    
    
    
        <script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?f089a91a688633df563c08899e3d893e";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f089a91a688633df563c08899e3d893e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    


<link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css"></head>
</html>
<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">程序员历小冰</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">主页</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/book">读书</a>
                
                    <a class="main-nav-link" href="/categories/plan">计划</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.jpeg">
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">主页</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/book">读书</a></td>
                
                    <td><a class="main-nav-link" href="/categories/plan">计划</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile" class="profile-fixed">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.jpeg">
            <h2 id="name">历小冰</h2>
            <h3 id="title">后端开发工程师</h3>
            <span id="location"><i class="fa fa-map-marker"></i>中国，南京</span>
            <img id="wechat" src="/css/images/wechat_public.jpg">
            <a id="follow" target="_blank" href="/css/images/wechat_public.jpg">⬆关注公众号⬆</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                90
                <span>posts</span>
            </div>
            <div class="article-info-block">
                61
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/ztelur" target="_blank" title="github" class="tooltip">
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/css/images/wechat.jpeg" target="_blank" title="wechat" class="tooltip">
                            <i class="fa fa-wechat"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/atom.xml" target="_blank" title="rss" class="tooltip">
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-Property-Animation框架详解-一" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/article/2f8becff/">Property Animation框架详解(一)</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/article/2f8becff/">
            <time datetime="2016-05-09T06:14:19.000Z" itemprop="datePublished">2016-05-09</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/animation/">animation</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>作者： <a href="http://ztelur.github.io/" target="_blank" rel="noopener">ztelur</a><br>联系方式：<a href="https://segmentfault.com/u/remcarpediem" target="_blank" rel="noopener">segmentfault</a>，<a href="http://blog.csdn.net/u012422440" target="_blank" rel="noopener">csdn</a>，<a href="http://www.jianshu.com/users/481d9f540fb9/latest_articles" target="_blank" rel="noopener">简书</a></p>
<blockquote>
<p>本文转载请注明原作者、文章来源，链接，版权归原文作者所有。</p>
</blockquote>
<p>&emsp;前段时间阅读了一篇关于Android动画学习的文章《如何学习 Android Animation？》，深感Android动画种类繁复，类型多遍，虽然自己实现过很多动画效果，但是对Android动画的整体领悟还有所欠缺，所以决定最近好好研究一下Android动画的相关内容。<br>&emsp;我首先决定好好看一下Android属性动画的相关源码，因为平时属性动画用的最多而且涉及的知识点也很多。于是写下这个系列的总结笔记吧，预计一共两篇文章。<br>&emsp;为了节约你的时间，本文主要内容如下:</p>
<ul>
<li><code>ValueAnimator</code>,<code>PropertyValuesHolder</code>和<code>Keyframe</code>之间的关系</li>
<li>使用<code>ValueAnimator</code>实现动画的背后原理，本篇不包括<code>Choreographer</code>原理的分析。</li>
<li><code>Keyframe</code>的动画数据计算原理。</li>
<li><code>ObjectAnimator</code>的属性赋值问题。</li>
</ul>
<p>&emsp;先上一张Android Animation相关的UML图吧。<br><img src="http://7xrxif.com1.z0.glb.clouddn.com/2016510-animation-Animation.jpg" alt="Android Property Animation 类图"></p>
<h4 id="使用ValueAnimator实现动画"><a href="#使用ValueAnimator实现动画" class="headerlink" title="使用ValueAnimator实现动画"></a><strong>使用ValueAnimator实现动画</strong></h4><p>&emsp;我们先来看<code>ValueAnimator</code>实现一个Android动画的小例子吧。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ValueAnimator animation = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line">animation.setDuration(<span class="number">1000</span>);</span><br><span class="line">animation.start();</span><br></pre></td></tr></table></figure></p>
<p>&emsp;当然，上述并不是全部的代码，你需要使用<code>AnimatorUpdateListener</code>来监控<code>ValueAnimator</code>来自己实视图属性设置来完成动画。<br>&emsp;下面，我们就以上述实例为基础，来讲述一下Android属性动画原理。</p>
<h4 id="ValueAnimator的初始化"><a href="#ValueAnimator的初始化" class="headerlink" title="ValueAnimator的初始化"></a><strong>ValueAnimator的初始化</strong></h4><p>&emsp;相信大家在使用<code>ValueAnimator</code>或者<code>ObjectAnimator</code>的使用，一般都是直接使用其工厂方法来获得对象实例，而不是直接new出来。我们现在就从<code>ofFloat</code>这个工厂方法入手，来分析一下<code>ValueAnimator</code>的初始化过程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ValueAnimator <span class="title">ofFloat</span><span class="params">(<span class="keyword">float</span>... values)</span> </span>&#123;</span><br><span class="line">    ValueAnimator anim = <span class="keyword">new</span> ValueAnimator();</span><br><span class="line">    anim.setFloatValues(values);</span><br><span class="line">    <span class="keyword">return</span> anim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;首先这个函数的参数是一个可变长参数，也就是说你既可以想第一节的例子一样传入两个值，也可以传入三个，四个值，也就是说传入的数值个数是不限的。传入数值个数不同，对其内部初始化过程有很大的影响，具体影响之后会讲到。</p>
<p>&emsp;<code>ValueAnimator</code>的构造函数是一个空函数，没有任何内容，所以我们直接调到<code>setFloatValues</code>函数。大家要注意的是，这个函数有对应的一系列函数，比如<code>setIntValues</code>，但是<code>setIntValues</code>会在<code>ofInt</code>这个工厂方法中被调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFloatValues</span><span class="params">(<span class="keyword">float</span>... values)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (values == <span class="keyword">null</span> || values.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mValues如果没有初始化或者无值的话</span></span><br><span class="line">    <span class="keyword">if</span> (mValues == <span class="keyword">null</span> || mValues.length == <span class="number">0</span>) &#123;</span><br><span class="line">        setValues(PropertyValuesHolder.ofFloat(<span class="string">""</span>, values));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//否则直接取出第一个位置的对象，进行复制。</span></span><br><span class="line">        PropertyValuesHolder valuesHolder = mValues[<span class="number">0</span>];</span><br><span class="line">        valuesHolder.setFloatValues(values);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// New property/values/target should cause re-initialization prior to starting</span></span><br><span class="line">    mInitialized = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;上述代码主要是进行<code>mValues</code>的初始化或者赋值，并涉及到<code>PropertyValuesHolder</code>的初始化过程了，相应得，<code>PropertyValuesHolder</code>的<code>setFloatValues</code>和<code>ofFloat</code>函数也是一系列函数中的一个，用于Float数据的初始化。<br>&emsp;<code>PropertyValuesHolder</code>这个类包含了属性(<code>Property</code>)和在动画期间属性的相关数值，它是属性动画中很重要的一个类，基本上属性的反射赋值，属性数值随时间变化的原理都在其中。它的<code>ofFloat</code>方法中就是实例化了一个<code>FloatPropertyValuesHolder</code>对象，它是<code>PropertyValuesHolder</code>的子类。所以我们直接看对应的构造函数及其相关函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">PropertyValuesHolder</span><span class="params">(String propertyName)</span> </span>&#123;</span><br><span class="line">    mPropertyName = propertyName;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FloatPropertyValuesHolder</span><span class="params">(String propertyName, <span class="keyword">float</span>... values)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(propertyName);</span><br><span class="line">    setFloatValues(values);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;从代码中可以看出，构造函数只是将传入的属性名赋值给<code>mPropertyName</code>,并且调用<code>setFloatValues</code>函数，仔细的读者可能会发现发现在<code>ValueAnimator</code>的<code>setFloatValues</code>函数中也调用了<code>PropertyValueHoler</code>的这个函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFloatValues</span><span class="params">(<span class="keyword">float</span>... values)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//做了两个事情,一是设置了类型,另外一个是生成了Keyframe,关键的类就是Keyframe啦</span></span><br><span class="line">    mValueType = <span class="keyword">float</span>.class;</span><br><span class="line">    mKeyframes = KeyframeSet.ofFloat(values);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;在<code>setFloatValues</code>中，函数记录了数值的类型<code>float.class</code>，这个在属性赋值时需要用到，并且使用<code>KeyframeSet</code>的<code>ofFloat</code>方法实例化了一个<code>Keyframe</code>。我们之前说<code>PropertyValueHoler</code>负责动画期间数值的变化，其实真正负责的对象是<code>Keyframe</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> KeyframeSet <span class="title">ofFloat</span><span class="params">(<span class="keyword">float</span>... values)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> numKeyframes = values.length;</span><br><span class="line">    FloatKeyframe keyframes[] = <span class="keyword">new</span> FloatKeyframe[Math.max(numKeyframes,<span class="number">2</span>)];</span><br><span class="line">    <span class="keyword">if</span> (numKeyframes == <span class="number">1</span>) &#123;</span><br><span class="line">        keyframes[<span class="number">0</span>] = (FloatKeyframe) Keyframe.ofFloat(<span class="number">0f</span>);</span><br><span class="line">        keyframes[<span class="number">1</span>] = (FloatKeyframe) Keyframe.ofFloat(<span class="number">1f</span>, values[<span class="number">0</span>]);</span><br><span class="line">        ....</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        keyframes[<span class="number">0</span>] = (FloatKeyframe) Keyframe.ofFloat(<span class="number">0f</span>, values[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; numKeyframes; ++i) &#123;</span><br><span class="line">            <span class="comment">// ofFloat的第一个参数会从小逐渐变大，最后为1f</span></span><br><span class="line">            keyframes[i] = (FloatKeyframe) Keyframe.ofFloat(</span><br><span class="line">                                      (<span class="keyword">float</span>) i / (numKeyframes - <span class="number">1</span>), values[i]);</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FloatKeyframeSet(keyframes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;说实话，刚看到这里，我并不是很明白<code>Keyframe</code>初始化的传参问题，为什么第一个参数fraction是从小到大最终为1呢？我们可以往看一下。<code>FloatKeyframe</code>的工厂方法和构造函数都很简单，只是将传入的参数赋值给成员变量。<code>FloatKeyframeSet</code>的构造函数也只是调用了<code>KeyframeSet</code>的构造函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">KeyframeSet</span><span class="params">(Keyframe... keyframes)</span> </span>&#123;</span><br><span class="line">    mNumKeyframes = keyframes.length;</span><br><span class="line">    mKeyframes = Arrays.asList(keyframes);</span><br><span class="line">    mFirstKeyframe = keyframes[<span class="number">0</span>];</span><br><span class="line">    mLastKeyframe = keyframes[mNumKeyframes - <span class="number">1</span>];</span><br><span class="line">    mInterpolator = mLastKeyframe.getInterpolator();<span class="comment">//以最后一个为准</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;看到这里大家可能感到疑惑，我们好像没有看到<code>Keyframe</code>中的<code>Interpolator</code>初始化啊，这是怎么回事呢？我检查了代码，它在<code>Keyframe</code>中确实没有初始化，而且必须通过<code>setInterpolator</code>，而且<code>KeyframeSet</code>中也没有进行相应的初始化。<br>&emsp;至此，<code>ValueAnimator</code>的整个初始化就结束了，它将<code>ValueAnimator</code>,<code>PropertyValueHoler</code>还有<code>Keyframe</code>连接起来，三者的职责划分十分清楚明了。</p>
<h4 id="动画start之后"><a href="#动画start之后" class="headerlink" title="动画start之后"></a><strong>动画start之后</strong></h4><p>&emsp;接着，我们就来看start函数调用之后的源码吧。我们直接来看<code>start(boolean)</code>这个函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">boolean</span> playBackwards)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Looper.myLooper() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AndroidRuntimeException(<span class="string">"Animators may only be run on Looper threads"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">    <span class="comment">//这边是重点，涉及到ThreadLocal的使用</span></span><br><span class="line">    AnimationHandler animationHandler = getOrCreateAnimationHandler();</span><br><span class="line">    animationHandler.mPendingAnimations.add(<span class="keyword">this</span>);</span><br><span class="line">    ....</span><br><span class="line">    animationHandler.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;省略的内容中是一些成员变量的赋值，比如<code>mPlayingBackwards</code>，<code>mSeekFraction</code>，和<code>mPlayingState</code>。大家从字面上就能理解它们的作用，这里就不细说。<br>&emsp;<code>getOrCreateAnimationHandler</code>中涉及到<code>ThreadLocal</code>的使用，相比了解<code>Handler</code>,<code>Looper</code>相关原理的同学都比较了解，这里也不具体讲解，感兴趣的同学可以去学习一下，可以简单的理解为每个线程都可以保存一个单例的一种实现方法。<br>&emsp;我们着重的了解一下<code>AnimationHandler</code>,它是<code>Runnable</code>的子类。它的<code>start</code>函数中直接调用了<code>scheduleAnimation</code>函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleAnimation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mAnimationScheduled) &#123;</span><br><span class="line">        mChoreographer.postCallback(Choreographer.CALLBACK_ANIMATION, <span class="keyword">this</span>, <span class="keyword">null</span>);</span><br><span class="line">        mAnimationScheduled = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;这里涉及了另外一个比较重要的类<code>Choreographer</code>，我们将在写一篇文章中详细说明这个类的代码，现在大家只要知道使用<code>postCallback</code>注册了这个类之后，它会协调不同动画或者其他活动的时间，并每隔一定时间之后调用该<code>Runnable</code>的<code>run</code>方法,并且<code>getFrameTime</code>可以获得调用时的时间，需要注意的是这个时间不一定是<code>System.nanoTime</code>。<br>&emsp;在<code>run()</code>函数里调用了<code>doAnimationFrame</code>并将<code>Choreographer</code>的<code>getFrameTime</code>获得的时间值传递进去。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">doAnimationFrame</span><span class="params">(<span class="keyword">long</span> frameTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPlayingState == STOPPED) &#123;</span><br><span class="line">        mPlayingState = RUNNING;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mPaused) &#123;</span><br><span class="line">        ....</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mResumed) &#123;</span><br><span class="line">      ....</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> currentTime = Math.max(frameTime, mStartTime);</span><br><span class="line">    <span class="keyword">return</span> animationFrame(currentTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;在<code>doAnimationFrame</code>中，程序会根据<code>mPlayingState</code>做一些相应的操作，并改变状态值，最后调用<code>animationFrame</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">animationFrame</span><span class="params">(<span class="keyword">long</span> currentTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> done = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">switch</span> (mPlayingState) &#123;</span><br><span class="line">    <span class="keyword">case</span> RUNNING:</span><br><span class="line">    <span class="keyword">case</span> SEEKED:</span><br><span class="line">        <span class="keyword">float</span> fraction = mDuration &gt; <span class="number">0</span> ? (<span class="keyword">float</span>)(currentTime - mStartTime) / mDuration : <span class="number">1f</span>;</span><br><span class="line">        ....</span><br><span class="line">        animateValue(fraction);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> done;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;我们可以看到，这里通过开始时间，当前事件和每帧动画间隔事件求出了一个<code>fraction</code>,然后代码中的省略部分主要是处理动画重复播放和倒着播发时的<code>fraction</code>处理，最后调用<code>animateValue</code>函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">animateValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</span><br><span class="line">    fraction = mInterpolator.getInterpolation(fraction);</span><br><span class="line">    mCurrentFraction = fraction;</span><br><span class="line">    <span class="keyword">int</span> numValues = mValues.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">        mValues[i].calculateValue(fraction);<span class="comment">//ViewPropertyViewHolder</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mUpdateListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> numListeners = mUpdateListeners.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</span><br><span class="line">            <span class="comment">//这边就结束啦，直接传递给AnimationUpdateListener</span></span><br><span class="line">            mUpdateListeners.get(i).onAnimationUpdate(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;这个函数是理解动画流程的关键之一，你首先可以看到<code>Interpolator</code>的使用，这个参数传入的<code>fraction</code>是通过动画开始时间和当前时间计算出来的，而通过不同<code>Interpolator</code>进行转换，无论是<code>BounceInterpolator</code>还是<code>LinerInterpolator</code>。接着，<code>ValueAnimator</code>调用了<code>mValues</code>保存的所有<code>ViewPropertyViewHolder</code>的<code>calculateValue</code>方法，让其去计算动画需要的数据。最后通过<code>AnimatorUpdateListenters</code>通知用户，然后我们会在回调函数中进行响应的操作。<code>ObjectAnimator</code>会override这个函数，然后加上属性反射赋值的相关逻辑。我们先来看如何计算动画所需的数值吧。</p>
<h4 id="动画所需数值计算"><a href="#动画所需数值计算" class="headerlink" title="动画所需数值计算"></a><strong>动画所需数值计算</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">calculateValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</span><br><span class="line">    mFloatAnimatedValue = mFloatKeyframes.getFloatValue(fraction);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;从代码上来看，<code>FloatViewPropertyViewHolder</code>将计算动画所需的数值的任务又交给了<code>Keyframe</code>,这也符合二者的职责分配。我们按照之前的分析，来看一下<code>FloatKeyframeSet</code>的响应操作。<code>getValue</code>中直接调用了<code>getFloatValue</code>函数，而后者是了解动画相关数值计算的关键函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getFloatValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//分为两种情况,一个是2 Keyframe时一般就是你给出两个值进行初始化,另外一个是多个keyframe时</span></span><br><span class="line">    <span class="keyword">if</span> (mNumKeyframes == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (firstTime) &#123;</span><br><span class="line">            firstTime = <span class="keyword">false</span>;</span><br><span class="line">            firstValue = ((FloatKeyframe) mKeyframes.get(<span class="number">0</span>)).getFloatValue();</span><br><span class="line">            lastValue = ((FloatKeyframe) mKeyframes.get(<span class="number">1</span>)).getFloatValue();</span><br><span class="line">            deltaValue = lastValue - firstValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果KeyframeSet也有Interpolator</span></span><br><span class="line">        <span class="keyword">if</span> (mInterpolator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            fraction = mInterpolator.getInterpolation(fraction);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果有Evaluator，那么使用它计算，如果没有就使用默认计算方法。</span></span><br><span class="line">        <span class="keyword">if</span> (mEvaluator == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> firstValue + fraction * deltaValue;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((Number)mEvaluator.evaluate(fraction, firstValue, lastValue)).floatValue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理多个Keyframe的情况</span></span><br><span class="line">    ..... <span class="comment">//省略代码处是处理fraction&lt;=0和fraction&gt;=1的特殊情况</span></span><br><span class="line">    FloatKeyframe prevKeyframe = (FloatKeyframe) mKeyframes.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; mNumKeyframes; ++i) &#123;</span><br><span class="line">        FloatKeyframe nextKeyframe = (FloatKeyframe) mKeyframes.get(i);</span><br><span class="line">        <span class="comment">//找到第一个可以处理这个fraction的keyframe。</span></span><br><span class="line">        <span class="keyword">if</span> (fraction &lt; nextKeyframe.getFraction()) &#123;</span><br><span class="line">            <span class="keyword">final</span> TimeInterpolator interpolator = nextKeyframe.getInterpolator();</span><br><span class="line">            <span class="keyword">if</span> (interpolator != <span class="keyword">null</span>) &#123;</span><br><span class="line">                fraction = interpolator.getInterpolation(fraction);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//在构造Keyframe时，我们知道第i个Keyframe的fraction就是i/(总个数)</span></span><br><span class="line">            <span class="comment">//所以下边这个计算公式就是将整个动画区间的fraction转变成prevKeyframe到nextKeyframe</span></span><br><span class="line">            <span class="comment">//这个小区间中的fraction</span></span><br><span class="line">            <span class="keyword">float</span> intervalFraction = (fraction - prevKeyframe.getFraction()) /</span><br><span class="line">                (nextKeyframe.getFraction() - prevKeyframe.getFraction());</span><br><span class="line">            <span class="comment">//用于计算动画数值的值区间是前一个Keyframe的value和当前的value</span></span><br><span class="line">            <span class="keyword">float</span> prevValue = prevKeyframe.getFloatValue();</span><br><span class="line">            <span class="keyword">float</span> nextValue = nextKeyframe.getFloatValue();</span><br><span class="line">            <span class="comment">//默认计算方式或者使用Evaluator进行计算</span></span><br><span class="line">            <span class="keyword">return</span> mEvaluator == <span class="keyword">null</span> ?</span><br><span class="line">                    prevValue + intervalFraction * (nextValue - prevValue) :</span><br><span class="line">                    ((Number)mEvaluator.evaluate(intervalFraction, prevValue, nextValue)).</span><br><span class="line">                        floatValue();</span><br><span class="line">        &#125;</span><br><span class="line">        prevKeyframe = nextKeyframe;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ((Number)mKeyframes.get(mNumKeyframes - <span class="number">1</span>).getValue()).floatValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;代码中有很详细的注释，大家自己阅读吧，理解这段代码，感觉对Android动画框架的理解十分的重要，你会对其中动画数值的计算有更加深刻的理解。</p>
<h4 id="ObjectAnimator的属性赋值"><a href="#ObjectAnimator的属性赋值" class="headerlink" title="ObjectAnimator的属性赋值"></a><strong>ObjectAnimator的属性赋值</strong></h4><p>&emsp;如果你使用<code>ObjectAnimator</code>来实现动画的话，我们可以验证上述关于<code>ValueAnimator</code>的梳理路线继续走下去，动画所需的数值已经计算完全，之后就是对属性继续赋值了。我们来看<code>ObjectAnimator</code>的<code>animateValue</code>函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">animateValue</span><span class="params">(<span class="keyword">float</span> fraction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Object target = getTarget();</span><br><span class="line">    <span class="comment">//target是一个WeakReference，使用前需要检查。</span></span><br><span class="line">    <span class="keyword">if</span> (mTarget != <span class="keyword">null</span> &amp;&amp; target == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cancel();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.animateValue(fraction);</span><br><span class="line">    <span class="keyword">int</span> numValues = mValues.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numValues; ++i) &#123;</span><br><span class="line">        <span class="comment">//这是使用反射将值赋给对象的啦.</span></span><br><span class="line">        mValues[i].setAnimatedValue(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;这个函数首先调用了父函数，进行计算数值，然后遍历<code>mValues</code>来设置对象的属性值。我们直接看<code>FloatPropertyValuesHolder</code>的<code>setAnimatedValue</code>函数。当然不同的<code>PropertyValuesHolder</code>子类的这个函数的实现都是差不多，只是涉及的数据类型不同。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAnimatedValue</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mFloatProperty != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mFloatProperty.setValue(target, mFloatAnimatedValue);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mProperty != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mProperty.set(target, mFloatAnimatedValue);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mJniSetter != <span class="number">0</span>) &#123;</span><br><span class="line">        nCallFloatMethod(target, mJniSetter, mFloatAnimatedValue);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mSetter != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mTmpValueArray[<span class="number">0</span>] = mFloatAnimatedValue;</span><br><span class="line">            mSetter.invoke(target, mTmpValueArray);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            Log.e(<span class="string">"PropertyValuesHolder"</span>, e.toString());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            Log.e(<span class="string">"PropertyValuesHolder"</span>, e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;通过上述代码，<code>ObjectAnimator</code>就将每一次计算而来的数值赋值给View的对象的相应属性上，形成了动画。</p>
<h4 id="后记"><a href="#后记" class="headerlink" title="后记"></a><strong>后记</strong></h4><p>&emsp;本文介绍了Android属性动画的基本框架流程，为的是让大家更好的理解Andorid动画。但是Android动画这一类的知识还是需要多多实践和练习才能发挥其正真的价值，所以，希望自己之后写出几个比较好的动画效果在来和大家进行分享吧。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://remcarpediem.net/article/2f8becff/" data-id="ck6535m7n00399kserh3v20w6" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-SICP-习题2-6之丘奇数" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/article/b367660b/">SICP 习题2.6之丘奇数</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/article/b367660b/">
            <time datetime="2016-05-01T11:34:38.000Z" itemprop="datePublished">2016-05-01</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/SICP/">SICP</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/SICP/">SICP</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>&emsp;最近一直在阅读《SICP》，然后下午做其中的习题2.6，对其题意很不理解，于是搜索了相关资料，不禁如题设所说感到如雷灌顶，特此记录下来，以供大家阅读和交流</p>
<p>####题目<br>&emsp;如果觉得将序对表示最为过程还不足以令人如雷灌顶，那么请考虑，在一个可以对程序做各类操作的语言中，我们完全可以没有数（至少在只考虑非整数的情况下），可以将0和加一操作实现为：<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> zero (<span class="name">lambda</span> (<span class="name">f</span>) (<span class="name">lambda</span> (<span class="name">x</span>) x)))</span><br><span class="line">(<span class="name">define</span> (<span class="name">add-1</span> n)</span><br><span class="line">	(<span class="name">lambda</span> (<span class="name">f</span>) (<span class="name">lambda</span> (<span class="name">x</span>) (<span class="name">f</span> ((<span class="name">n</span> f) x)))))</span><br></pre></td></tr></table></figure></p>
<p>这一表现形式称为Church计数，名字来源于其发明人数理学家Church，请直接定义one和two（不使用zero和add-1）（提示：利用代换法去求值）。请给出加法过程+的一个直接定义（不要反复应用add-1）</p>
<h4 id="丘奇数"><a href="#丘奇数" class="headerlink" title="丘奇数"></a>丘奇数</h4><p>&emsp;说实话，我一直没有看懂题目中关于zero和add-1的定义，于是我搜索了相关资料。下边就结合资料谈一下它的概念。<br>&emsp;首先要明确的是丘奇数中的zero，one等并不等同于数值上的0,1,2。你可以理解为它是零这个概念的一种表现形式。换句话说，它就是零的函数式表现形式。我们先来看一下丘奇数中zero，one和two的表现形式<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> zero</span><br><span class="line">  (<span class="name">lambda</span> (<span class="name">f</span>) (<span class="name">lambda</span> (<span class="name">x</span>) x)))</span><br><span class="line">(<span class="name">define</span> one</span><br><span class="line">  (<span class="name">lambda</span> (<span class="name">f</span>) (<span class="name">lambda</span> (<span class="name">x</span>) (<span class="name">f</span> x))))</span><br><span class="line">(<span class="name">define</span> two</span><br><span class="line">  (<span class="name">lambda</span> (<span class="name">f</span>) (<span class="name">lambda</span> (<span class="name">x</span>) (<span class="name">f</span> (<span class="name">f</span> x)))))</span><br></pre></td></tr></table></figure></p>
<p>&emsp;我们会发现zero，one和two都是一个函数，它接收(f)作为参数，其结果是一个接收(x)作为参数的函数。大家可能需要注意的是，(f)在这里显然也是一个函数，在LISP中函数是可以作为输入参数的。然后我们会发现zero，one和two的区别好像就是(f)函数被使用的次数。zero中(f)没有被使用，one中(f)使用了一次，two中(f)使用了两次，对就是这个次数来表示0,1,2的概念。<br>&emsp;我们可以实验一下检验一下<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">inc</span> n)</span><br><span class="line">   (<span class="name">+</span> n <span class="number">1</span>))</span><br><span class="line">&gt; ((<span class="name">zero</span> inc) <span class="number">0</span>)</span><br><span class="line"><span class="number">0</span></span><br><span class="line">&gt; ((<span class="name">zero</span> inc) <span class="number">1</span>)</span><br><span class="line"><span class="number">1</span></span><br><span class="line">&gt; ((<span class="name">one</span> inc) <span class="number">1</span>)</span><br><span class="line"><span class="number">2</span></span><br><span class="line">&gt; (((<span class="name">add-1</span> one) inc) <span class="number">1</span>)</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;我们定义一个过程inc就是数值意义上的加一，然后使用zero,one和add-1发现确实如同我们所想的，zero表示inc过程不会被使用，返回原数值；one表示inc被使用一次，返回加一的数值。</p>
<h4 id="替换法求two"><a href="#替换法求two" class="headerlink" title="替换法求two"></a>替换法求two</h4><p>&emsp;我们来使用替换法通过add-1和zero来求解one吧。<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">add-1</span> zero)</span><br><span class="line"><span class="comment">;展开add-1定义</span></span><br><span class="line">(<span class="name">lambda</span> (<span class="name">f</span>) (<span class="name">lambda</span> (<span class="name">x</span>) (<span class="name">f</span> ((<span class="name">zero</span> f) x))))</span><br><span class="line"></span><br><span class="line"><span class="comment">; 替换zero</span></span><br><span class="line">(<span class="name">lambda</span> (<span class="name">f</span>) (<span class="name">lambda</span> (<span class="name">x</span>) (<span class="name">f</span> ((<span class="name">lambda</span> (<span class="name">x</span>) x) x))))</span><br><span class="line"></span><br><span class="line"><span class="comment">; 简化因为((lambda (x) x) x)就等于x</span></span><br><span class="line">(<span class="name">lambda</span> (<span class="name">f</span>) (<span class="name">lambda</span> (<span class="name">x</span>) (<span class="name">f</span> x)))</span><br></pre></td></tr></table></figure></p>
<h4 id="加法定义"><a href="#加法定义" class="headerlink" title="加法定义"></a>加法定义</h4><p>&emsp;首先我们要明白丘奇数加法的含义，我们先记其加法为add-church,那么如下代码所示，最后一个过程得出的值应该是多少呢？<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; ((<span class="name">one</span> inc) <span class="number">1</span>)</span><br><span class="line"><span class="number">2</span></span><br><span class="line">&gt; ((<span class="name">two</span> inc) <span class="number">1</span>)</span><br><span class="line"><span class="number">3</span></span><br><span class="line">&gt; (((<span class="name">add-church</span> one two) inc) <span class="number">1</span>)</span><br><span class="line">?</span><br></pre></td></tr></table></figure></p>
<p>&emsp;根据猜测，应该是4吧。因为one表示inc对1这个数值使用一次，two标示使用两次，那么将二者加起来，那么就应该是three的含义啦，就是表示inc对1这个数值使用3次，那么就是4啦。<br>&emsp;add-church的实现如下<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">define</span> (<span class="name">add-church</span> m n)</span><br><span class="line">   (<span class="name">lambda</span> (<span class="name">f</span>) (<span class="name">lambda</span> (<span class="name">x</span>) ((<span class="name">m</span> f) ((<span class="name">n</span> f) x)))))</span><br></pre></td></tr></table></figure></p>
<p>&emsp;如果你将其与add-1进行对比，你会发现add-1中的f变成了(m f),如果吧add-1中的f记住(one f)，你可能就会更加理解。那么你就会想add-m是如何标示的呢？</p>
<blockquote>
<p>参考资料<br><a href="https://pfmiles.wordpress.com/2009/11/12/%E9%80%90%E6%AD%A5%E7%90%86%E8%A7%A3%E4%B8%98%E5%A5%87%E6%95%B0%E4%B8%80/" target="_blank" rel="noopener">https://pfmiles.wordpress.com/2009/11/12/%E9%80%90%E6%AD%A5%E7%90%86%E8%A7%A3%E4%B8%98%E5%A5%87%E6%95%B0%E4%B8%80/</a><br><a href="http://www.billthelizard.com/2010/10/sicp-26-church-numerals.html" target="_blank" rel="noopener">http://www.billthelizard.com/2010/10/sicp-26-church-numerals.html</a></p>
</blockquote>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://remcarpediem.net/article/b367660b/" data-id="ck6535m8000419kselua3kkj7" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-Android-Scroll详解-三-：Android-绘制过程详解" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/article/74701e27/">Android Scroll详解(三)：Android 绘制过程详解</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/article/74701e27/">
            <time datetime="2016-04-21T14:09:03.000Z" itemprop="datePublished">2016-04-21</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/draw/">draw</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>作者： <a href="http://www.jianshu.com/users/481d9f540fb9/latest_articles" target="_blank" rel="noopener">ztelur</a><br>联系方式：<a href="https://segmentfault.com/u/remcarpediem" target="_blank" rel="noopener">segmentfault</a>，<a href="http://blog.csdn.net/u012422440" target="_blank" rel="noopener">csdn</a>，<a href="http://ztelur.github.io/" target="_blank" rel="noopener">github</a></p>
<blockquote>
<p>本文转载请注明原作者、文章来源，链接，版权归原文作者所有。</p>
</blockquote>
<p>&emsp;本篇为Android Scroll系列文章的最后一篇，主要讲解Android视图绘制机制，由于本系列文章内容都是视图滚动相关的，所以，本篇从视图内容滚动的视角来梳理视图绘制过程。<br>&emsp;如果没有看过本系列之前文章或者不太了解相关的知识，请大家阅读一下一下的文章：</p>
<ul>
<li><a href="http://ztelur.github.io/2016/03/16/Android-MotionEvent%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">Android MotionEvent详解</a></li>
<li><a href="http://ztelur.github.io/2016/03/27/Android-Scroll%E8%AF%A6%E8%A7%A3-%E4%B8%80-%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" target="_blank" rel="noopener">Android Scroll详解(一)：基础知识</a></li>
<li><a href="http://ztelur.github.io/2016/04/07/Android-Scroll%E8%AF%A6%E8%A7%A3-%E4%BA%8C-%EF%BC%9AOverScroller%E5%AE%9E%E6%88%98/" target="_blank" rel="noopener">Android Scroll详解(二)：OverScroller实战</a></li>
</ul>
<p>&emsp;为了节约大家的时间，本文内容主要如下：</p>
<ul>
<li><code>Scroller</code>相关机制。</li>
<li><code>mScrollX</code>和<code>mScrollY</code>是如何影响视图内容。</li>
<li>Android视图绘制逻辑，包括相关API和<code>Canvas</code>的相关操作。</li>
</ul>
<h3 id="一切从Scroller使用开始"><a href="#一切从Scroller使用开始" class="headerlink" title="一切从Scroller使用开始"></a>一切从<code>Scroller</code>使用开始</h3><p>&emsp;使用scroller的实例代码，之后的讲解流程就是scroller和computeScroll是如何调用的啦。<br>&emsp;在系列文章的第二篇中，我们具体学习了<code>Scroller</code>的使用方法。通过<code>Scroller</code>的<code>fling</code>和<code>View</code>的<code>computeScroll</code>的配合，实现视图滚动效果。实例代码如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.....</span><br><span class="line">mScroller.fling(<span class="number">0</span>,getScrollY(),<span class="number">0</span>,speed,<span class="number">0</span>,<span class="number">0</span>,-<span class="number">500</span>,<span class="number">10000</span>)</span><br><span class="line">invalidate();</span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (mScroller.computeScrollOffset()) &#123;        </span><br><span class="line">			scrollTo(mScroller.getCurrX(),</span><br><span class="line">					mScroller.getCurrY());</span><br><span class="line">           postInvalidate();</span><br><span class="line">	    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;本篇文章就带大家探究一下这段代码背后的原理和机制。</p>
<h3 id="Invalidate的寻父之路"><a href="#Invalidate的寻父之路" class="headerlink" title="Invalidate的寻父之路"></a>Invalidate的寻父之路</h3><p>&emsp;这一节主要分析在View中调用<code>invalidate</code>到<code>ViewRoot</code>执行<code>performTraversals</code>的原理，对android视图架构不是很熟悉的同学可以先阅读一下<a href="http://blog.csdn.net/u012422440/article/details/51173387" target="_blank" rel="noopener">《Android视图架构详解》</a>。<br><img src="http://7xrxif.com1.z0.glb.clouddn.com/2016421-view-invalidate%E6%97%B6%E5%BA%8F%E5%9B%BE2.jpg" alt="invalidate时序图"></p>
<p>&emsp;我们先来看一下<code>View</code>中的<code>invalidate</code>代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    invalidate(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(<span class="keyword">boolean</span> invalidateCache)</span> </span>&#123;</span><br><span class="line">    invalidateInternal(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop, invalidateCache, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">invalidateInternal</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b, <span class="keyword">boolean</span> invalidateCache,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> fullInvalidate)</span> </span>&#123;</span><br><span class="line">		.....</span><br><span class="line">		<span class="comment">//DRAWN和HAS_BOUNDS是否被设置为１，说明上一次请求执行的UI绘制已经完成，那么可以再次请求执行</span></span><br><span class="line">        <span class="keyword">if</span> ((mPrivateFlags &amp; (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)) == (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)</span><br><span class="line">                || (invalidateCache &amp;&amp; (mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == PFLAG_DRAWING_CACHE_VALID)</span><br><span class="line">                || (mPrivateFlags &amp; PFLAG_INVALIDATED) != PFLAG_INVALIDATED</span><br><span class="line">                || (fullInvalidate &amp;&amp; isOpaque() != mLastIsOpaque)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fullInvalidate) &#123;</span><br><span class="line">                mLastIsOpaque = isOpaque();</span><br><span class="line">                mPrivateFlags &amp;= ~PFLAG_DRAWN;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mPrivateFlags |= PFLAG_DIRTY;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (invalidateCache) &#123; <span class="comment">//是否让view的缓存都失效</span></span><br><span class="line">                mPrivateFlags |= PFLAG_INVALIDATED;</span><br><span class="line">                mPrivateFlags &amp;= ~PFLAG_DRAWING_CACHE_VALID;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Propagate the damage rectangle to the parent view.</span></span><br><span class="line">            <span class="keyword">final</span> AttachInfo ai = mAttachInfo;</span><br><span class="line">            <span class="keyword">final</span> ViewParent p = mParent;</span><br><span class="line">			<span class="comment">//通过ViewParent来执行操作，如果当前视图是顶层视图也就是DecorView的视图，那么它的</span></span><br><span class="line">			<span class="comment">//mParent就是ViewRoot对象，所以是通过ViewRoot的对象来实现的。</span></span><br><span class="line">            <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; ai != <span class="keyword">null</span> &amp;&amp; l &lt; r &amp;&amp; t &lt; b) &#123;</span><br><span class="line">                <span class="keyword">final</span> Rect damage = ai.mTmpInvalRect;</span><br><span class="line">                damage.set(l, t, r, b);</span><br><span class="line">                p.invalidateChild(<span class="keyword">this</span>, damage);<span class="comment">//<span class="doctag">TODO:</span>这是invalidate执行的主体</span></span><br><span class="line">            &#125;</span><br><span class="line">            .....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;我们可以看到，调用<code>invalidate()</code>会导致整个视图进行刷新，并且会刷新缓存。<br>&emsp;然后我们再来详细的研究一下<code>invalidateInternal</code>中的代码。我们先来着重看一下<code>if</code>语句的判断条件把。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((mPrivateFlags &amp; (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)) == (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)</span><br><span class="line">        || (invalidateCache &amp;&amp; (mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == PFLAG_DRAWING_CACHE_VALID)</span><br><span class="line">        || (mPrivateFlags &amp; PFLAG_INVALIDATED) != PFLAG_INVALIDATED</span><br><span class="line">        || (fullInvalidate &amp;&amp; isOpaque() != mLastIsOpaque))</span><br></pre></td></tr></table></figure></p>
<ul>
<li>当<code>mPrivateFlags</code>的<code>FLAG_DRAWN</code>和<code>FLAG_HAS_BOUNDS</code>位设置为1时，说明上一次请求执行的UI绘制已经完成，那么可以再次请求重新绘制。<code>FLAG_DRAWN</code>位会在<code>draw</code>函数中会被置为１，而<code>FLAG_HAS_BOUNDS</code>会在<code>setFrame</code>函数中被设置为1。</li>
<li><code>mPrivateFlags</code>的<code>PFLAG_DRAWING_CACHE_VALID</code>标示视图缓存是否有效，如果有效并且<code>invalidateCache</code>为true,那么可以请求重新绘制。</li>
<li>另外两个布尔判断的具体含义并没有分析清楚，大家感兴趣的请自行研究。<br>&emsp;然后将<code>mPrivateFlags</code>的<code>PFLAG_DIRTY</code>置为１。并且如果是要刷新缓存的话，将<code>PFLAG_INVALIDATED</code>位设置为１，并且将<code>PFLAG_DRAWING_CACHE_VALID</code>位设置为0,这一步和之前的<code>if</code>判断中后两个布尔判断相对应，可见，如果已经有一个<code>invalidate</code>设置了上述两个标志位，那么下一个<code>invalidate</code>就不会进行任何操作。<br>&emsp;接着，调用ViewParent接口的invalidateChild函数，在《Android视图架构详解》，我们已经知道<code>ViewGroup</code>和<code>ViewRoot</code>都实现了上述接口，那么，根据Android视图树状结构，<code>ViewGroup</code>的相应方法会被调用。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invalidateChild</span><span class="params">(View child, <span class="keyword">final</span> Rect dirty)</span> </span>&#123;</span><br><span class="line">    ViewParent parent = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</span><br><span class="line">    <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ....</span><br><span class="line">        <span class="comment">// while一直向上递归</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            ......</span><br><span class="line">            parent = parent.invalidateChildInParent(location, dirty);</span><br><span class="line">            ....</span><br><span class="line">        &#125; <span class="keyword">while</span> (parent != <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewParent <span class="title">invalidateChildInParent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span>[] location, <span class="keyword">final</span> Rect dirty)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_DRAWN) == PFLAG_DRAWN ||</span><br><span class="line">            (mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == PFLAG_DRAWING_CACHE_VALID) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; (FLAG_OPTIMIZE_INVALIDATE | FLAG_ANIMATION_DONE)) !=</span><br><span class="line">                    FLAG_OPTIMIZE_INVALIDATE) &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">return</span> mParent;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            .....</span><br><span class="line">            <span class="keyword">return</span> mParent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>&emsp;通过上述代码我们可以看到<code>ViewGroup</code>的<code>invalidateChild</code>函数通过循环不断调用其父视图的<code>invalidateChildInParent</code>，而且我们知道<code>ViewRoot</code>是<code>DecorView</code>的父视图，也就是说<code>ViewRoot</code>是Android视图树状结构的根。所以，最终<code>ViewRoot</code>的<code>invalidateChildInParent</code>会被调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment">//在ViewGroup的invalidateChildInParent中ｗｈｉｌｅ循环，一直调用到这里，然后在调用invalidateChild</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewParent <span class="title">invalidateChildInParent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span>[] location, <span class="keyword">final</span> Rect dirty)</span> </span>&#123;</span><br><span class="line">        invalidateChild(<span class="keyword">null</span>, dirty);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidateChild</span><span class="params">(View child, Rect dirty)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//先检查线程,必须是主线程</span></span><br><span class="line">    checkThread();</span><br><span class="line">    .....</span><br><span class="line">    <span class="comment">//如果mWillDrawSoon为true那么就是消息队列中已经有一个DO_TRAVERSAL的消息啦</span></span><br><span class="line">    <span class="keyword">if</span> (!mWillDrawSoon) &#123;</span><br><span class="line">         <span class="comment">//直接调用了这个喽</span></span><br><span class="line">        scheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;最终，在<code>ViewRoot</code>的<code>invalidateChild</code>函数中，调用了<code>scheduleTraversals</code>,开启了视图重绘之旅。</p>
<h3 id="我们都被ViewRoot骗了"><a href="#我们都被ViewRoot骗了" class="headerlink" title="我们都被ViewRoot骗了"></a>我们都被<code>ViewRoot</code>骗了</h3><p>&emsp;<code>ViewRoot</code>是Android视图树状结构的根节点，并且它实现了<code>ViewParent</code>接口，是<code>DecorView</code>的父视图。那么大家一定会认为它就是一个<code>View</code>吧。那我们就被它给骗了！！<code>ViewRoot</code>本质上是一个<code>Handler</code>，我们可以看一下<code>scheduleTraversals</code>到<code>performTraversals</code>的原理就知道了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</span><br><span class="line">        mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">        sendEmptyMessage(DO_TRAVERSAL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;在<code>scheduleTraversals</code>中，<code>ViewRoot</code>只是向自己发送了一个<code>DO_TRAVERSAL</code>的空信息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">case</span> DO_TRAVERSAL:</span><br><span class="line">    <span class="comment">//这里就是Handle处理travel信息的地方</span></span><br><span class="line">        <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">            Debug.startMethodTracing(<span class="string">"ViewRoot"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        performTraversals();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mProfile) &#123;</span><br><span class="line">            Debug.stopMethodTracing();</span><br><span class="line">            mProfile = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;然后我们在查看<code>handleMessage</code>方法，发现在处理<code>DO_TRAVERSAL</code>时，<code>ViewRoot</code>调用了<code>performTraversals</code>函数。<br>&emsp;在<code>performTraversals</code>中，视图要进行measure,layout,和draw三大步骤，篇幅有限，我们这里只研究绘制相关的机制。<br>&emsp;<code>ViewRoot</code>在<code>performTraversals</code>中调用了自身的<code>draw</code>方法，看吧，<code>ViewRoot</code>伪装的还挺像，连<code>draw</code>方法都有。但是我们会发现，在<code>draw</code>方法中，<code>ViewRoot</code>实际上只调用了自己的<code>mView</code>成员变量的<code>draw</code>方法，而且我们都知道的是，<code>mView</code>就是<code>DecorView</code>，于是，绘制流程来到了真正的View视图的根节点。</p>
<h3 id="大家都来画的canvas"><a href="#大家都来画的canvas" class="headerlink" title="大家都来画的canvas"></a>大家都来画的canvas</h3><p>&emsp;接下来，我们就正式研究一下Android的绘制机制，我们沿着Android视图的树状结构来分析绘制原理。<br><img src="http://7xrxif.com1.z0.glb.clouddn.com/2016421-view-draw%E6%97%B6%E5%BA%8F%E5%9B%BE.jpg" alt="draw 时序图"></p>
<p>&emsp;首先是<code>DecorView</code>的绘制相关的函数。在<code>ViewRoot</code>的<code>draw</code>方法中，直接调用了<code>DecorView</code>的<code>draw(Canvas canvas)</code>函数，我们知道<code>DecorView</code>是<code>FrameLayout</code>的子类，其<code>draw(Canvas canvas)</code>函数是从<code>View</code>中继承而来的。所以我们先来看<code>View</code>的<code>draw(Canvas canvas)</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// http://grepcode.com/file/repository.grepcode.com/java/ext/com.google.android/android/5.1.1_r1/android/view/View.java#View</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">         ........</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Draw traversal performs several drawing steps which must be executed</span></span><br><span class="line"><span class="comment">         * in the appropriate order:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *      1. Draw the background</span></span><br><span class="line"><span class="comment">         *      2. If necessary, save the canvas' layers to prepare for fading</span></span><br><span class="line"><span class="comment">         *      3. Draw view's content</span></span><br><span class="line"><span class="comment">         *      4. Draw children</span></span><br><span class="line"><span class="comment">         *      5. If necessary, draw the fading edges and restore layers</span></span><br><span class="line"><span class="comment">         *      6. Draw decorations (scrollbars for instance)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 1, draw the background, if needed</span></span><br><span class="line">        <span class="keyword">if</span> (!dirtyOpaque) &#123;</span><br><span class="line">            drawBackground(canvas);</span><br><span class="line">        &#125;</span><br><span class="line">        .......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 2, save the canvas' layers</span></span><br><span class="line">        .......</span><br><span class="line">        <span class="comment">// Step 3, draw the content</span></span><br><span class="line">        <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 4, draw the children</span></span><br><span class="line">        dispatchDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 5, draw the fade effect and restore layers</span></span><br><span class="line">        .......</span><br><span class="line">        <span class="keyword">if</span> (drawTop) &#123;</span><br><span class="line">            matrix.setScale(<span class="number">1</span>, fadeHeight * topFadeStrength);</span><br><span class="line">            matrix.postTranslate(left, top);</span><br><span class="line">            fade.setLocalMatrix(matrix);</span><br><span class="line">            p.setShader(fade);</span><br><span class="line">            canvas.drawRect(left, top, right, top + length, p);</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">        <span class="comment">// Step 6, draw decorations (scrollbars)</span></span><br><span class="line">        onDrawScrollBars(canvas);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;关于视图的组成部分，我在之前的文章中已经讲述过来，请不太熟悉这部分内容的同学自行查阅文章或者其他资料。通过上述代码我们可以看到，<code>View</code>的<code>dispatchDraw</code>函数被调用了，它是向子视图分发绘制指令和相关数据的方法。在<code>View</code>中，上述函数是一个空函数，但是<code>ViewGroup</code>中对这个函数进行了实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = usingRenderNodeProperties</span><br><span class="line">            ? <span class="keyword">null</span> : buildOrderedChildList();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; isChildrenDrawingOrderEnabled();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenCount; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> childIndex = customOrder ? getChildDrawingOrder(childrenCount, i) : i;</span><br><span class="line">        <span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</span><br><span class="line">                ? children[childIndex] : preorderedList.get(childIndex);</span><br><span class="line">        <span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//在这里drawChild</span></span><br><span class="line">            more |= drawChild(canvas, child, drawingTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">drawChild</span><span class="params">(Canvas canvas, View child, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</span><br><span class="line"><span class="comment">//这里就调用child的draw方法啦，而不是draw(canvas)方法！！！！！</span></span><br><span class="line">    <span class="keyword">return</span> child.draw(canvas, <span class="keyword">this</span>, drawingTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;通过上述代码我们可以看到，<code>ViewGroup</code>分别调用了自己的子View的<code>draw</code>方法，需要特别注意的是，这个draw和之前draw方法不是同一个方法，他们的参数不同。于是，我们再次转到<code>View</code>的源码中，看一下这个draw方法到底做了什么。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">draw</span><span class="params">(Canvas canvas, ViewGroup parent, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">//进行计算滚动</span></span><br><span class="line">    <span class="keyword">if</span> (!hasDisplayList) &#123;</span><br><span class="line">        computeScroll();</span><br><span class="line">        sx = mScrollX;</span><br><span class="line">        sy = mScrollY;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//这里进行了平移。</span></span><br><span class="line">    <span class="keyword">if</span> (offsetForScroll) &#123;</span><br><span class="line">        canvas.translate(mLeft - sx, mTop - sy);</span><br><span class="line">    &#125;</span><br><span class="line">    ..... </span><br><span class="line">    <span class="keyword">if</span> (!layerRendered) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!hasDisplayList) &#123;</span><br><span class="line">        <span class="comment">// Fast path for layouts with no backgrounds</span></span><br><span class="line">        <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_SKIP_DRAW) == PFLAG_SKIP_DRAW) &#123;</span><br><span class="line">          mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK;</span><br><span class="line">          dispatchDraw(canvas);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 在这里调用了draw</span></span><br><span class="line">          draw(canvas);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; </span><br><span class="line">            ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;首先，我们发现<code>computeScroll</code>方法是在其中被调用的，从而计算出新的<code>mScrollX</code>和<code>mScrollY</code>,然后在平移画布，产生内容平移效果。<br>&emsp;然后我们发现通过<code>PFLAG_SKIP_DRAW</code>标志位的判断，有些View是直接调用<code>dispatchDraw</code>函数，说明它自己没有需要绘制的内容，而有些View则是调用自己的<code>draw</code>方法。我们应该都知道<code>ViewGroup</code>默认是不进行绘制内容的吧，我们一般调用<code>setNotWillDraw</code>方法来让其可以绘制自身内容，通过调用<code>setNotWillDraw</code>方法，会导致<code>PFLAG_SKIP_DRAW</code>位被置为１，从而可以绘制自身内容。<br>&emsp;分析到这里，我们就会发现draw函数沿着Android视图树状结构被不断调用，知道所有视图都完成绘制。</p>
<h3 id="把一切连接起来的computeScroll"><a href="#把一切连接起来的computeScroll" class="headerlink" title="把一切连接起来的computeScroll"></a>把一切连接起来的computeScroll</h3><p>&emsp;读到这里大家应该对Android视图绘制流程有了基本的了解了吧，那么，我们再来看一下文章开头的例子。在<code>computeScroll</code>方法中，我们调用了<code>postInvalidate</code>方法，这又是什么用意呢？<br>&emsp;其实，在<code>computeScroll</code>中不掉用<code>postInvalidate</code>好像也可以达到正确的效果，具体原因我不太了解，猜测应该是Android自动刷新界面可以代替<code>postInvalidate</code>的效果吧。同学们如果知道其中具体原因，请告知我啊。<br>&emsp;在《Android Scroll详解(一)：基础知识》中，我们已经讲到<br><code>postInvalidate</code>其实就是调用了<code>invalidate</code>，然后整个流程就连接了起来，<code>mScrollX</code>和<code>mScrollY</code>每个循环都会改变一点，然后导致界面滚动，最终形成界面Scroll效果。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>&emsp;Android Scroll的系列文章就此结束了，希望大家从中学习到有用的知识。如果其中有任何错误或者容易误解的地方，请大家及时通知我。谢谢各位读者和同学。</p>
<p><a href="http://www.cppblog.com/fwxjj/archive/2013/01/13/197231.html" target="_blank" rel="noopener">http://www.cppblog.com/fwxjj/archive/2013/01/13/197231.html</a><br><a href="http://blog.csdn.net/luoshengyang/article/details/8372924" target="_blank" rel="noopener">http://blog.csdn.net/luoshengyang/article/details/8372924</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://remcarpediem.net/article/74701e27/" data-id="ck6535m6g000p9kse46l88y2v" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-Android视图架构详解" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/article/1172bb49/">Android视图架构详解</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/article/1172bb49/">
            <time datetime="2016-04-17T06:56:23.000Z" itemprop="datePublished">2016-04-17</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/View-Architecture/">View Architecture</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>作者： <a href="http://www.jianshu.com/users/481d9f540fb9/latest_articles" target="_blank" rel="noopener">ztelur</a><br>联系方式：<a href="https://segmentfault.com/u/remcarpediem" target="_blank" rel="noopener">segmentfault</a>，<a href="http://blog.csdn.net/u012422440" target="_blank" rel="noopener">csdn</a>，<a href="http://ztelur.github.io/" target="_blank" rel="noopener">github</a></p>
<blockquote>
<p>本文仅供个人学习，不用于任何形式商业目的，转载请注明原作者、文章来源，链接，版权归原文作者所有。</p>
</blockquote>
<p>&emsp;最近一直在研究<code>View</code>的绘制相关的机制，发现需要补充一下Android View Architecture的相关知识，所以就特地研究了一下这方面的代码，写成本篇文章<br>&emsp;为了节约你的时间，本篇文章内容大致如下:</p>
<ul>
<li><code>Activity</code>，<code>DecorView</code>，<code>PhoneWindow</code>和<code>ViewRoot</code>的作用和相关关系</li>
</ul>
<h3 id="Android-View-Architecture"><a href="#Android-View-Architecture" class="headerlink" title="Android View Architecture"></a>Android View Architecture</h3><p>&emsp;先来几张图，大致展现一下Android 视图架构的大概。</p>
<blockquote>
<p>感谢网友提醒，泛化和实现这两种关系的箭头画反啦。以后要仔细学一遍UML了，平时经常画，如果有错误可真是闹笑话啊。</p>
</blockquote>
<p><img src="http://7xrxif.com1.z0.glb.clouddn.com/2016417-view-View%20Architecutre%E7%B1%BB%E5%9B%BE.jpg" alt="View Architecutre类图"></p>
<p><img src="http://7xrxif.com1.z0.glb.clouddn.com/2016417-view-%E8%A7%86%E5%9B%BE%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="视图关系图.png"></p>
<p><img src="http://7xrxif.com1.z0.glb.clouddn.com/2016417-view-View%E6%A0%91%E7%8A%B6%E7%BB%93%E6%9E%84%E5%9B%BE.png" alt="View树状结构图.png"></p>
<h3 id="Activity和Window"><a href="#Activity和Window" class="headerlink" title="Activity和Window"></a>Activity和Window</h3><p>&emsp;总所周知,Activity并不负责视图控制，它只是控制生命周期和处理事件，真正控制视图的是<code>Window</code>。一个Activity包含了一个Window，Window才是真正代表一个窗口，也就是说Activity可以没有Window，那就相当于是Service了。在<code>ActivityThread</code>中也有控制<code>Service</code>的相关函数或许正好印证了这一点。<br>&emsp;<code>Activity</code>和<code>Window</code>的第一次邂逅是在<code>ActivityThread</code>调用<code>Activity</code>的<code>attach()</code>函数时。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[window]:通过PolicyManager创建window,实现callback函数,所以,当window接收到</span></span><br><span class="line"><span class="comment">//外界状态改变时,会调用activity的方法,</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">        Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">        NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config, String referrer, IVoiceInteractor voiceInteractor)</span> </span>&#123;</span><br><span class="line">    ....</span><br><span class="line">    mWindow = PolicyManager.makeNewWindow(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//当window接收系统发送给它的IO输入事件时,例如键盘和触摸屏事件,就可以转发给相应的Activity</span></span><br><span class="line">    mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">    .....</span><br><span class="line">    <span class="comment">//设置本地窗口管理器</span></span><br><span class="line">    mWindow.setWindowManager(</span><br><span class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</span><br><span class="line">            mToken, mComponent.flattenToString(),</span><br><span class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;在<code>attach()</code>中，新建一个<code>Window</code>实例作为自己的成员变量，它的类型为<code>PhoneWindow</code>,这是抽象类<code>Window</code>的一个子类。然后设置<code>mWindow</code>的<code>WindowManager</code>。</p>
<h3 id="Window-Activity和DecorView"><a href="#Window-Activity和DecorView" class="headerlink" title="Window,Activity和DecorView"></a>Window,Activity和DecorView</h3><p>&emsp;<code>DecorView</code>是<code>FrameLayout</code>的子类，它可以被认为是Android视图树的根节点视图。<code>DecorView</code>作为顶级View，一般情况下它内部包含一个竖直方向的<code>LinearLayout</code>，在这个LinearLayout里面有上下两个部分（具体情况和Android版本及主体有关），上面的是标题栏，下面的是内容栏。在Activity中通过setContentView所设置的布局文件其实就是被加到内容栏之中的，而内容栏的id是content，在代码中可以通过ViewGroup content = （ViewGroup)findViewById(R.android.id.content)来得到content对应的layout。<br>&emsp;<code>Window</code>中有几个视图相关的比较重要的成员变量如下所示:</p>
<ul>
<li><code>mDecor</code>:<code>DecorView</code>的实例，标示<code>Window</code>内部的顶级视图</li>
<li><code>mContentParent</code>:<code>setContetView</code>所设置的布局文件就加到这个视图中</li>
<li><code>mContentRoot</code>:是<code>DecorView</code>的唯一子视图，内部包含<code>mContentParent</code>,标题栏和状态栏。</li>
</ul>
<p>&emsp;Activity中不仅持有一个<code>Window</code>实例，还有一个类型为<code>View</code>的<code>mDecor</code>实例。这个实例和<code>Window</code>中的<code>mDecor</code>实例有什么关系呢？它又是什么时候被创建的呢？<br>&emsp;二者其实指向同一个对象，这个对象是在<code>Activity</code>调用<code>setContentView</code>时创建的。我们都知道<code>Activity</code>的<code>setContentView</code>实际上是调用了<code>Window</code>的<code>setContentView</code>方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123; <span class="comment">//[window]如何没有DecorView,那么就新建一个</span></span><br><span class="line">        installDecor(); <span class="comment">//[window]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        mContentParent.removeAllViews();</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">//[window]第二步,将layout添加到mContentParent</span></span><br><span class="line">    mLayoutInflater.inflate(layoutResID, mContentParent);</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;代码很清楚的显示了布局文件的视图是添加到<code>mContentParent</code>中，而且<code>Window</code>通过<code>installDecor</code>来新建<code>DecorView</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[window]创建一个decorView</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mDecor = generateDecor(); <span class="comment">//直接new出一个DecorView返回</span></span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//[window] 这一步也是很重要的.</span></span><br><span class="line">        mContentParent = generateLayout(mDecor); <span class="comment">//mContentParent是setContentVIew的关键啊</span></span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Apply data from current theme.</span></span><br><span class="line">    .......</span><br><span class="line">    <span class="comment">//[window] 根据不同的style生成不同的decorview啊</span></span><br><span class="line">    View in = mLayoutInflater.inflate(layoutResource, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 加入到deco中,所以应该是其第一个child</span></span><br><span class="line">    decor.addView(in, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">    mContentRoot = (ViewGroup) in; <span class="comment">//给DecorView的第一个child是mContentView</span></span><br><span class="line">    <span class="comment">// 这是获得所谓的content </span></span><br><span class="line">    ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">return</span> contentParent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;从上述的代码中，我们可以清楚的看到<code>mDecor</code>和<code>mContentParent</code>和<code>mContentRoot</code>的关系。<br>&emsp;那么，<code>Activity</code>中的<code>mDecor</code>是何时被赋值的？我们如何确定它和<code>Widnow</code>中的<code>mDecor</code>指向同一个对象呢？我们可以查看<code>ActivityThread</code>的<code>handleResumeActivity</code>函数，它负责处理<code>Activity</code>的<code>resume</code>阶段。在这个函数中，Android直接将<code>Window</code>中的<code>DecorView</code>实例赋值给<code>Activity</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Activity a = r.activity;</span><br><span class="line">r.window = r.activity.getWindow();</span><br><span class="line">View decor = r.window.getDecorView();</span><br><span class="line">decor.setVisibility(View.INVISIBLE);</span><br><span class="line">ViewManager wm = a.getWindowManager();</span><br><span class="line">WindowManager.LayoutParams l = r.window.getAttributes();</span><br><span class="line">a.mDecor = decor;</span><br></pre></td></tr></table></figure></p>
<h3 id="Window，DecorView-和-ViewRoot"><a href="#Window，DecorView-和-ViewRoot" class="headerlink" title="Window，DecorView 和 ViewRoot"></a>Window，DecorView 和 ViewRoot</h3><p>&emsp;<code>ViewRoot</code>对应<code>ViewRootImpl</code>类，它是连接<code>WindowManagerService</code>和<code>DecorView</code>的纽带，View的三大流程(测量（measure），布局（layout），绘制（draw）)均通过ViewRoot来完成。<code>ViewRoot</code>并不属于View树的一份子。从源码实现上来看，它既非View的子类，也非View的父类，但是，它实现了<code>ViewParent</code>接口，这让它可以作为<code>View</code>的名义上的父视图。<code>RootView</code>继承了<code>Handler</code>类，可以接收事件并分发，Android的所有触屏事件、按键事件、界面刷新等事件都是通过ViewRoot进行分发的。<strong>ViewRoot可以被理解为“View树的管理者”——它有一个mView成员变量，它指向的对象和上文中<code>Window</code>和<code>Activity</code>的<code>mDecor</code>指向的对象是同一个对象</strong>。</p>
<p>&emsp;我们来先看一下<code>ViewRoot</code>的创建过程。由于<code>ViewRoot</code>作为<code>WindowMangerService</code>和<code>DecorView</code>的纽带，只有在<code>WindowManager</code>将持有<code>DecorView</code>的<code>Window</code>添加进窗口管理器才创建。我们可以查看<code>WindowMangerGlobal</code>中的<code>addView</code>函数。对<code>WindowManager</code>不太熟悉的同学可以参考<a href="http://ztelur.github.io/2015/10/28/Window%E5%92%8CWindowManager%E8%A7%A3%E6%9E%90/" target="_blank" rel="noopener">《Window和WindowManager解析》</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></span><br><span class="line"><span class="function"><span class="params">        Display display, Window parentWindow)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建ViewRootImpl,然后将下述对象添加到列表中</span></span><br><span class="line">    ....</span><br><span class="line">    root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</span><br><span class="line"></span><br><span class="line">    view.setLayoutParams(wparams);</span><br><span class="line"></span><br><span class="line">    mViews.add(view);</span><br><span class="line">    mRoots.add(root);</span><br><span class="line">    mParams.add(wparams);</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 添加啦!!!!!!!!这是通过ViewRootImpl的setView来完成，这个View就是DecorView实例</span></span><br><span class="line">        root.setView(view, wparams, panelParentView);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">      ....</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;那么，<code>Window</code>是什么时候被添加到<code>WindowManager</code>中的呢？我们回到<code>ActivityThread</code>的<code>handleResumeActivity</code>函数。我们都知道Activity的resume阶段就是要显示到屏幕上的阶段，在Activity也就是<code>DecorView</code>将要显示到屏幕时，系统才会调用<code>addView</code>方法。<br>&emsp;我们在<code>handleResumeActivity</code>函数中找到了下面一段代码,它调用了<code>Activity</code>的<code>makeVisible()</code>函数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ActivityThread</span></span><br><span class="line">r.activity.makeVisible();</span><br><span class="line"></span><br><span class="line"><span class="comment">//Activity</span></span><br><span class="line">    <span class="comment">//[windows] DecorView正式添加并显示</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makeVisible</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!mWindowAdded) &#123;</span><br><span class="line">            ViewManager wm = getWindowManager();</span><br><span class="line">            wm.addView(mDecor, getWindow().getAttributes());</span><br><span class="line">            mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mDecor.setVisibility(View.VISIBLE);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;我们通过源代码发现，正式在<code>makeVisible</code>函数中，系统进行了<code>Window</code>的添加。</p>
<p>引用<br><a href="http://wiki.jikexueyuan.com/project/deep-android-v1/surface.html" target="_blank" rel="noopener">http://wiki.jikexueyuan.com/project/deep-android-v1/surface.html</a><br><a href="http://blog.csdn.net/guxiao1201/article/details/41744107" target="_blank" rel="noopener">http://blog.csdn.net/guxiao1201/article/details/41744107</a><br><a href="http://forlan.iteye.com/blog/2269381" target="_blank" rel="noopener">http://forlan.iteye.com/blog/2269381</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://remcarpediem.net/article/1172bb49/" data-id="ck6535m6q001c9kseix7f9che" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-Android-Scroll详解-二-：OverScroller实战" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/article/e2cc6893/">Android Scroll详解(二)：OverScroller实战</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/article/e2cc6893/">
            <time datetime="2016-04-07T14:58:49.000Z" itemprop="datePublished">2016-04-07</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/scroll/">scroll</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>作者： <a href="http://www.jianshu.com/users/481d9f540fb9/latest_articles" target="_blank" rel="noopener">ztelur</a><br>联系方式：<a href="https://segmentfault.com/u/remcarpediem" target="_blank" rel="noopener">segmentfault</a>，<a href="http://blog.csdn.net/u012422440" target="_blank" rel="noopener">csdn</a>，<a href="http://ztelur.github.io/" target="_blank" rel="noopener">github</a></p>
<blockquote>
<p>本文仅供个人学习，不用于任何形式商业目的，转载请注明原作者、文章来源，链接，版权归原文作者所有。</p>
</blockquote>
<p>&emsp;本文是android滚动相关的系列文章的第二篇，主要总结一下使用手势相关的代码逻辑。主要是单点拖动，多点拖动，fling和OveScroll的实现。每个手势都会有代码片段。<br>&emsp;对android滚动相关的知识还不太了解的同学可以先阅读一下文章：</p>
<ul>
<li><a href="http://ztelur.github.io/2016/03/16/Android-MotionEvent%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">《Android-MotionEvent详解》</a></li>
<li><a href="http://ztelur.github.io/2016/03/27/Android-Scroll%E8%AF%A6%E8%A7%A3-%E4%B8%80-%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" target="_blank" rel="noopener">《Android Scroll详解(一)：基础知识》</a></li>
</ul>
<p>&emsp;为了节约你的时间，我特地将文章大致内容总结如下：</p>
<ul>
<li>手势Drag的实现和原理</li>
<li>手势Fling的实现和原理</li>
<li>OverScroll效果和EdgeEffect效果的实现和原理。</li>
</ul>
<p>&emsp;详细代码请查看<a href="https://github.com/ztelur/ScrollProject" target="_blank" rel="noopener">我的github</a></p>
<h3 id="Drag"><a href="#Drag" class="headerlink" title="Drag"></a>Drag</h3><p>&emsp;Drag是最为基本的手势：用户可以使用手指在屏幕上滑动，以拖动屏幕相应内容移动。实现Drag手势其实很简单，步骤如下：</p>
<ul>
<li>在<code>ACTION_DOWN</code>事件发生时，调用<code>getX</code>和<code>getY</code>函数获得事件发生的x,y坐标值，并记录在<code>mLastX</code>和<code>mLastY</code>变量中。</li>
<li>在<code>ACTION_MOVE</code>事件发生时，调用<code>getX</code>和<code>getY</code>函数获得事件发生的x,y坐标值,将其与<code>mLastX</code>和<code>mLastY</code>比较，如果二者差值大于一定限制（ScaledTouchSlop）,就执行<code>scrollBy</code>函数，进行滚动,最后更新<code>mLastX</code>和<code>mLastY</code>的值。</li>
<li>在<code>ACTION_UP</code>和<code>ACTION_CANCEL</code>事件发生时，清空<code>mLastX</code>，<code>mLastY</code>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> actionId = MotionEventCompat.getActionMasked(event);</span><br><span class="line">    <span class="keyword">switch</span> (actionId) &#123;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">            mLastX = event.getX();</span><br><span class="line">            mLastY = event.getY();</span><br><span class="line">            mIsBeingDragged = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (getParent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                getParent().requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">            <span class="keyword">float</span> curX = event.getX();</span><br><span class="line">            <span class="keyword">float</span> curY = event.getY();</span><br><span class="line">            <span class="keyword">int</span> deltaX = (<span class="keyword">int</span>) (mLastX - curX);</span><br><span class="line">            <span class="keyword">int</span> deltaY = (<span class="keyword">int</span>) (mLastY - curY);</span><br><span class="line">            <span class="keyword">if</span> (!mIsBeingDragged &amp;&amp; (Math.abs(deltaX)&gt; mTouchSlop ||</span><br><span class="line">                                                    Math.abs(deltaY)&gt; mTouchSlop)) &#123;</span><br><span class="line">                mIsBeingDragged = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">// 让第一次滑动的距离和之后的距离不至于差距太大</span></span><br><span class="line">                <span class="comment">// 因为第一次必须&gt;TouchSlop,之后则是直接滑动</span></span><br><span class="line">                <span class="keyword">if</span> (deltaX &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    deltaX -= mTouchSlop;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    deltaX += mTouchSlop;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (deltaY &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    deltaY -= mTouchSlop;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    deltaY += mTouchSlop;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 当mIsBeingDragged为true时，就不用判断&gt; touchSlopg啦，不然会导致滚动是一段一段的</span></span><br><span class="line">            <span class="comment">// 不是很连续</span></span><br><span class="line">            <span class="keyword">if</span> (mIsBeingDragged) &#123;</span><br><span class="line">                    scrollBy(deltaX, deltaY);</span><br><span class="line">                    mLastX = curX;</span><br><span class="line">                    mLastY = curY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">            mIsBeingDragged = <span class="keyword">false</span>;</span><br><span class="line">            mLastY = <span class="number">0</span>;</span><br><span class="line">            mLastX = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mIsBeingDragged;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多触点Drag"><a href="#多触点Drag" class="headerlink" title="多触点Drag"></a>多触点Drag</h3><p>&emsp;上边的代码只适用于单点触控的手势，如果你是两个手指触摸屏幕，那么它只会根据你第一个手指滑动的情况来进行屏幕滚动。更为致命的是，当你先松开第一个手指时，由于我们少监听了<code>ACTION_POINTER_UP</code>事件，将会导致屏幕突然滚动一大段距离，因为第二个手指移动事件的x,y值会和第一个手指移动时留下的<code>mLastX</code>和<code>mLastY</code>比较，导致屏幕滚动。</p>
<p>&emsp;如果我们要监听并处理多触点的事件，我们还需要对<code>ACTION_POINTER_DOWN</code>和<code>ACTION_POINTER_UP</code>事件进行监听，并且在<code>ACTION_MOVE</code>事件时，要记录所有触摸点事件发生的x,y值。</p>
<ul>
<li>当<code>ACTION_POINTER_DOWN</code>事件发生时，我们要记录第二触摸点事件发生的x,y值为<code>mSecondaryLastX</code>和<code>mSecondaryLastY</code>，和第二触摸点pointer的id为<code>mSecondaryPointerId</code></li>
<li>当<code>ACTION_MOVE</code>事件发生时，我们除了根据第一触摸点pointer的x，y值进行滚动外，也要更新<code>mSecondayLastX</code>和<code>mSecondaryLastY</code></li>
<li>当<code>ACTION_POINTER_UP</code>事件发生时，我们要先判断是哪个触摸点手指被抬起来啦，如果是第一触摸点，那么我们就将坐标值和pointer的id都更换为第二触摸点的数据；如果是第二触摸点，就只要重置一下数据即可。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (actionId) &#123;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN:</span><br><span class="line">        activePointerIndex = MotionEventCompat.getActionIndex(event);</span><br><span class="line">        mSecondaryPointerId = MotionEventCompat.findPointerIndex(event,activePointerIndex);</span><br><span class="line">        mSecondaryLastX = MotionEventCompat.getX(event,activePointerIndex);</span><br><span class="line">        mSecondaryLastY = MotionEventCompat.getY(event,activePointerIndex);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// handle secondary pointer move</span></span><br><span class="line">        <span class="keyword">if</span> (mSecondaryPointerId != INVALID_ID) &#123;</span><br><span class="line">            <span class="keyword">int</span> mSecondaryPointerIndex = MotionEventCompat.findPointerIndex(event, mSecondaryPointerId);</span><br><span class="line">            mSecondaryLastX = MotionEventCompat.getX(event, mSecondaryPointerIndex);</span><br><span class="line">            mSecondaryLastY = MotionEventCompat.getY(event, mSecondaryPointerIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP:</span><br><span class="line">        <span class="comment">//判断是否是activePointer up了</span></span><br><span class="line">        activePointerIndex = MotionEventCompat.getActionIndex(event);</span><br><span class="line">        <span class="keyword">int</span> curPointerId  = MotionEventCompat.getPointerId(event,activePointerIndex);</span><br><span class="line">        Log.e(TAG, <span class="string">"onTouchEvent: "</span>+activePointerIndex +<span class="string">" "</span>+curPointerId +<span class="string">" activeId"</span>+mActivePointerId+</span><br><span class="line">                                <span class="string">"secondaryId"</span>+mSecondaryPointerId);</span><br><span class="line">        <span class="keyword">if</span> (curPointerId == mActivePointerId) &#123; <span class="comment">// active pointer up</span></span><br><span class="line">            mActivePointerId = mSecondaryPointerId;</span><br><span class="line">            mLastX = mSecondaryLastX;</span><br><span class="line">            mLastY = mSecondaryLastY;</span><br><span class="line">            mSecondaryPointerId = INVALID_ID;</span><br><span class="line">            mSecondaryLastY = <span class="number">0</span>;</span><br><span class="line">            mSecondaryLastX = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//重复代码，为了让逻辑看起来更加清晰</span></span><br><span class="line">        &#125; <span class="keyword">else</span>&#123; <span class="comment">//如果是secondary pointer up</span></span><br><span class="line">            mSecondaryPointerId = INVALID_ID;</span><br><span class="line">            mSecondaryLastY = <span class="number">0</span>;</span><br><span class="line">            mSecondaryLastX = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">    <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">        mIsBeingDragged = <span class="keyword">false</span>;</span><br><span class="line">        mActivePointerId = INVALID_ID;</span><br><span class="line">        mLastY = <span class="number">0</span>;</span><br><span class="line">        mLastX = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Fling"><a href="#Fling" class="headerlink" title="Fling"></a>Fling</h3><p>&emsp;当用户手指快速划过屏幕，然后快速立刻屏幕时，系统会判定用户执行了一个Fling手势。视图会快速滚动，并且在手指立刻屏幕之后也会滚动一段时间。Drag表示手指滑动多少距离，界面跟着显示多少距离，而fling是根据你的滑动方向与轻重，还会自动滑动一段距离。Filing手势在android交互设计中应用非常广泛：电子书的滑动翻页、ListView滑动删除item、滑动解锁等。所以如何检测用户的fling手势是非常重要的。<br>&emsp;在检测Fling时，你需要检测手指在屏幕上滑动的速度，这是你就需要<code>VelocityTracker</code>和<code>Scroller</code>这两个类啦。</p>
<ul>
<li>我们首先使用<code>VelocityTracker.obtain()</code>这个方法获得其实例</li>
<li>然后每次处理触摸时间时，我们将触摸事件通过<code>addMovement</code>方法传递给它</li>
<li>最后在处理<code>ACTION_UP</code>事件时，我们通过<code>computeCurrentVelocity</code>方法获得滑动速度;</li>
<li>我们判断滑动速度是否大于一定数值(MinFlingSpeed),如果大于，那么我们调用<code>Scroller</code>的<code>fling</code>方法。然后调用<code>invalidate()</code>函数。</li>
<li>我们需要重载<code>computeScroll</code>方法，在这个方法内，我们调用<code>Scroller</code>的<code>computeScrollOffset()</code>方法啦计算当前的偏移量，然后获得偏移量，并调用<code>scrollTo</code>函数,最后调用<code>postInvalidate()</code>函数。</li>
<li>除了上述的操作外，我们需要在处理<code>ACTION_DOWN</code>事件时，对屏幕当前状态进行判断，如果屏幕现在正在滚动(用户刚进行了Fling手势)，我们需要停止屏幕滚动。</li>
</ul>
<p>&emsp;具体这一套流程是如何运转的，我会在下一篇文章中详细解释，大家也可以自己查阅代码或者google来搞懂其中的原理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">       .....</span><br><span class="line">       <span class="keyword">if</span> (mVelocityTracker == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//检查速度测量器，如果为null，获得一个</span></span><br><span class="line">           mVelocityTracker = VelocityTracker.obtain();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(event);</span><br><span class="line">       <span class="keyword">int</span> index = -<span class="number">1</span>;</span><br><span class="line">       <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">               ......</span><br><span class="line">                               <span class="keyword">if</span> (!mScroller.isFinished()) &#123; <span class="comment">//fling</span></span><br><span class="line">                   mScroller.abortAnimation();</span><br><span class="line">               &#125;</span><br><span class="line">               .....</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">               ......</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">               endDrag();</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">               <span class="keyword">if</span> (mIsBeingDragged) &#123;</span><br><span class="line">               <span class="comment">//当手指立刻屏幕时，获得速度，作为fling的初始速度     mVelocityTracker.computeCurrentVelocity(1000,mMaxFlingSpeed);</span></span><br><span class="line">                   <span class="keyword">int</span> initialVelocity = (<span class="keyword">int</span>)mVelocityTracker.getYVelocity(mActivePointerId);</span><br><span class="line">                   <span class="keyword">if</span> (Math.abs(initialVelocity) &gt; mMinFlingSpeed) &#123;</span><br><span class="line">                       <span class="comment">// 由于坐标轴正方向问题，要加负号。</span></span><br><span class="line">                       doFling(-initialVelocity);</span><br><span class="line">                   &#125;</span><br><span class="line">                   endDrag();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//每次onTouchEvent处理Event时，都将event交给时间</span></span><br><span class="line">       <span class="comment">//测量器</span></span><br><span class="line">       <span class="keyword">if</span> (mVelocityTracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">           mVelocityTracker.addMovement(event);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doFling</span><span class="params">(<span class="keyword">int</span> speed)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mScroller == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       mScroller.fling(<span class="number">0</span>,getScrollY(),<span class="number">0</span>,speed,<span class="number">0</span>,<span class="number">0</span>,-<span class="number">500</span>,<span class="number">10000</span>);</span><br><span class="line">       invalidate();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mScroller.computeScrollOffset()) &#123;</span><br><span class="line">           scrollTo(mScroller.getCurrX(),mScroller.getCurrY());</span><br><span class="line">           postInvalidate();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="OverScroll"><a href="#OverScroll" class="headerlink" title="OverScroll"></a>OverScroll</h4><p>&emsp;在Android手机上，当我们滚动屏幕内容到达内容边界时，如果再滚动就会有一个发光效果。而且界面会进行滚动一小段距离之后再回复原位，这些效果是如何实现的呢？我们需要使用<code>Scroller</code>和<code>scrollTo</code>的升级版<code>OverScroller</code>和<code>overScrollBy</code>了，还有发光的<code>EdgeEffect</code>类。<br>&emsp;我们先来了解一下相关的API，理解了这些接口参数的含义，你就可以轻松使用这些接口来实现上述的效果啦。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">overScrollBy</span><span class="params">(<span class="keyword">int</span> deltaX, <span class="keyword">int</span> deltaY,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> scrollX, <span class="keyword">int</span> scrollY,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> scrollRangeX, <span class="keyword">int</span> scrollRangeY,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> maxOverScrollX, <span class="keyword">int</span> maxOverScrollY,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> isTouchEvent)</span></span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>int deltaX,int deltaY : 偏移量，也就是当前要滚动的x，y值。</li>
<li>int scrollX,int scrollY : 当前的mScrollX和mScrollY的值。</li>
<li>int scrollRangeX,int scrollRangeY: 标示可以滚动的最大的x,y值，也就是你视图真实的长和宽。也就是说，你的视图可视大小可能是100,100,但是视图中的内容的大小为200,200,所以，上述两个值就为200,200</li>
<li>int maxOverScrollX,int maxOverScrollY：允许超过滚动范围的最大值，x方向的滚动范围就是0~maxOverScrollX,y方向的滚动范围就是0~maxOverScrollY。</li>
<li>boolean isTouchEvent:是否在<code>onTouchEvent</code>中调用的这个函数。所以，当你在<code>computeScroll</code>中调用这个函数时，就可以传入false。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onOverScrolled</span><span class="params">(<span class="keyword">int</span> scrollX, <span class="keyword">int</span> scrollY, <span class="keyword">boolean</span> clampedX, <span class="keyword">boolean</span> clampedY)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>int scrollX,int scrollY:就是x，y方向的滚动距离，就相当于<code>mScrollX</code>和<code>mScrollY</code>。你既可以直接把二者赋值给相应的成员变量，也可以使用<code>scrollTo</code>函数。</li>
<li>boolean clampedX,boolean clampY:表示是否到达超出滚动范围的最大值。如果为true，就需要调用<code>OverScroll</code>的<code>springBack</code>函数来让视图回复原来位置。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">springBack</span><span class="params">(<span class="keyword">int</span> startX, <span class="keyword">int</span> startY, <span class="keyword">int</span> minX, <span class="keyword">int</span> maxX, <span class="keyword">int</span> minY, <span class="keyword">int</span> maxY)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>int startX,int startY:标示当前的滚动值，也就是<code>mScrollX</code>和<code>mScrollY</code>的值。</li>
<li>int minX,int maxX:标示x方向的合理滚动值</li>
<li>int minY,int maxY:标示y方向的合理滚动值。</li>
</ul>
<p>&emsp;相信看完上述的API之后，大家会有很多的疑惑，所以这里我来举个例子。<br>&emsp;假设视图大小为100*100。当你一直下拉到视图上边缘，然后在下拉，这时，<code>mScrollY</code>已经达到或者超过正常的滚动范围的最小值了，也就是0，但是你的maxOverScrollY传入的是10,所以，<code>mScrollY</code>最小可以到达-10,最大可以为110。所以，你可以继续下拉。等到<code>mScrollY</code>到达或者超过-10时，clampedY就为true，标示视图已经达到可以OverScroll的边界，需要回滚到正常滚动范围，所以你调用springBack(0,0,0,100)。</p>
<p>&emsp;然后我们再来看一下发光效果是如何实现的。<br>&emsp;使用<code>EdgeEffect</code>类。一般来说，当你只上下滚动时，你只需要两个<code>EdgeEffect</code>实例，分别代表上边界和下边界的发光效果。你需要在下面两个情景下改变<code>EdgeEffect</code>的状态，然后在<code>draw()</code>方法中绘制<code>EdgeEffect</code></p>
<ul>
<li>处理<code>ACTION_MOVE</code>时，如果发现y方向的滚动值超过了正常范围的最小值时，你需要调用上边界实例的<code>onPull</code>方法。如果是超过最大值，那么就是调用下边界的<code>onPull</code>方法。</li>
<li>在<code>computeScroll</code>函数中，也就是说Fling手势执行过程中，如果发现y方向的滚动值超过正常范围时的最小值时，调用<code>onAbsorb</code>函数。</li>
</ul>
<p>&emsp;然后就是重载<code>draw</code>方法，让<code>EdgeEffect</code>实例在画布上绘制自己。你会发现，你必须对画布进行移动或者旋转来让<code>EdgeEffect</code>绘制出上边界或者下边界的发光的效果，因为<code>EdgeEffect</code>对象自己是没有上下左右的概念的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.draw(canvas);</span><br><span class="line">       <span class="keyword">if</span> (mEdgeEffectTop != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> scrollY = getScrollY();</span><br><span class="line">           <span class="keyword">if</span> (!mEdgeEffectTop.isFinished()) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> count = canvas.save();</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> width = getWidth() - getPaddingLeft() - getPaddingRight();</span><br><span class="line">               canvas.translate(getPaddingLeft(),Math.min(<span class="number">0</span>,scrollY));</span><br><span class="line">               mEdgeEffectTop.setSize(width,getHeight());</span><br><span class="line">               <span class="keyword">if</span> (mEdgeEffectTop.draw(canvas)) &#123;</span><br><span class="line">                   postInvalidate();</span><br><span class="line">               &#125;</span><br><span class="line">               canvas.restoreToCount(count);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (mEdgeEffectBottom != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> scrollY = getScrollY();</span><br><span class="line">           <span class="keyword">if</span> (!mEdgeEffectBottom.isFinished()) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> count = canvas.save();</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> width = getWidth() - getPaddingLeft() - getPaddingRight();</span><br><span class="line">               canvas.translate(-width+getPaddingLeft(),Math.max(getScrollRange(),scrollY)+getHeight());</span><br><span class="line">               canvas.rotate(<span class="number">180</span>,width,<span class="number">0</span>);</span><br><span class="line">               mEdgeEffectBottom.setSize(width,getHeight());</span><br><span class="line">               <span class="keyword">if</span> (mEdgeEffectBottom.draw(canvas)) &#123;</span><br><span class="line">                   postInvalidate();</span><br><span class="line">               &#125;</span><br><span class="line">               canvas.restoreToCount(count);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">           ......</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">               .....</span><br><span class="line">               <span class="keyword">if</span> (mIsBeingDragged) &#123;</span><br><span class="line">                   overScrollBy(<span class="number">0</span>,(<span class="keyword">int</span>)deltaY,<span class="number">0</span>,getScrollY(),<span class="number">0</span>,getScrollRange(),<span class="number">0</span>,mOverScrollDistance,<span class="keyword">true</span>);</span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">int</span> pulledToY = (<span class="keyword">int</span>)(getScrollY()+deltaY);</span><br><span class="line">                   mLastY = y;</span><br><span class="line">                   <span class="keyword">if</span> (pulledToY&lt;<span class="number">0</span>) &#123;</span><br><span class="line">                       mEdgeEffectTop.onPull(deltaY/getHeight(),event.getX(mActivePointerId)/getWidth());</span><br><span class="line">                       <span class="keyword">if</span> (!mEdgeEffectBottom.isFinished()) &#123;</span><br><span class="line">                           mEdgeEffectBottom.onRelease();</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span>(pulledToY&gt; getScrollRange()) &#123;</span><br><span class="line">                       mEdgeEffectBottom.onPull(deltaY/getHeight(),<span class="number">1.0f</span>-event.getX(mActivePointerId)/getWidth());</span><br><span class="line">                       <span class="keyword">if</span> (!mEdgeEffectTop.isFinished()) &#123;</span><br><span class="line">                           mEdgeEffectTop.onRelease();</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">if</span> (mEdgeEffectTop != <span class="keyword">null</span> &amp;&amp; mEdgeEffectBottom != <span class="keyword">null</span> &amp;&amp;(!mEdgeEffectTop.isFinished()</span><br><span class="line">                                       || !mEdgeEffectBottom.isFinished())) &#123;</span><br><span class="line">                       postInvalidate();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               .....</span><br><span class="line">       &#125;</span><br><span class="line">       ....</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onOverScrolled</span><span class="params">(<span class="keyword">int</span> scrollX, <span class="keyword">int</span> scrollY, <span class="keyword">boolean</span> clampedX, <span class="keyword">boolean</span> clampedY)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (!mScroller.isFinished()) &#123;  </span><br><span class="line">           <span class="keyword">int</span> oldX = getScrollX();</span><br><span class="line">           <span class="keyword">int</span> oldY = getScrollY();</span><br><span class="line">           scrollTo(scrollX,scrollY);</span><br><span class="line">           onScrollChanged(scrollX,scrollY,oldX,oldY);</span><br><span class="line">           <span class="keyword">if</span> (clampedY) &#123;</span><br><span class="line">               Log.e(<span class="string">"TEST1"</span>,<span class="string">"springBack"</span>);</span><br><span class="line">               mScroller.springBack(getScrollX(),getScrollY(),<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,getScrollRange());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// TouchEvent中的overScroll调用</span></span><br><span class="line">           <span class="keyword">super</span>.scrollTo(scrollX,scrollY);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mScroller.computeScrollOffset()) &#123;</span><br><span class="line">           <span class="keyword">int</span> oldX = getScrollX();</span><br><span class="line">           <span class="keyword">int</span> oldY = getScrollY();</span><br><span class="line">           <span class="keyword">int</span> x = mScroller.getCurrX();</span><br><span class="line">           <span class="keyword">int</span> y = mScroller.getCurrY();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">int</span> range = getScrollRange();</span><br><span class="line">           <span class="keyword">if</span> (oldX != x || oldY != y) &#123;</span><br><span class="line">               overScrollBy(x-oldX,y-oldY,oldX,oldY,<span class="number">0</span>,range,<span class="number">0</span>,mOverFlingDistance,<span class="keyword">false</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> overScrollMode = getOverScrollMode();</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> canOverScroll = overScrollMode == OVER_SCROLL_ALWAYS ||</span><br><span class="line">                   (overScrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp; range &gt; <span class="number">0</span>);</span><br><span class="line">           <span class="keyword">if</span> (canOverScroll) &#123;</span><br><span class="line">               <span class="keyword">if</span> (y&lt;<span class="number">0</span> &amp;&amp; oldY &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                   mEdgeEffectTop.onAbsorb((<span class="keyword">int</span>)mScroller.getCurrVelocity());</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y&gt; range &amp;&amp; oldY &lt; range) &#123;</span><br><span class="line">                   mEdgeEffectBottom.onAbsorb((<span class="keyword">int</span>)mScroller.getCurrVelocity());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>&emsp;本篇文章是系列文章的第二篇，大家可能已经知道如何实现各类手势，但是对其中的机制和原理还不是很了解，之后的第三篇会讲解从本篇代码的视角讲解一下android视图绘制的原理和Scroller的机制，希望大家多多关注。</p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="http://stackoverflow.com/questions/22843671/android-swipe-vs-fling" target="_blank" rel="noopener">http://stackoverflow.com/questions/22843671/android-swipe-vs-fling</a></p>
<p><a href="https://www.google.com/design/spec/patterns/gestures.html#gestures-drag-swipe-or-fling-details" target="_blank" rel="noopener">https://www.google.com/design/spec/patterns/gestures.html#gestures-drag-swipe-or-fling-details</a></p>
<p><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2014/1212/2145.html" target="_blank" rel="noopener">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2014/1212/2145.html</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://remcarpediem.net/article/e2cc6893/" data-id="ck6535m6h000q9kseajbmziyk" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-《异类-不一样成功的启示录》读后感" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/article/6407985a/">《异类-不一样成功的启示录》读后感</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/article/6407985a/">
            <time datetime="2016-04-05T15:01:59.000Z" itemprop="datePublished">2016-04-05</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/读书笔记/">读书笔记</a>
    </div>

                        
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>&emsp;前几天清明节，放假三天，可惜三天再下雨，真是清明时节雨纷纷啊。下雨就不能出去游玩，于是呆在屋里，一口气把《异类：不一样成功的启示录》这本书看完了。<br>&emsp;本书的作者是格拉德威尔，他的著作及文章常涉及到出乎意料的社会科学研究领域，尤其是在社会学、心理学、社会心理学方面，对学术工作的应用层面做出了广泛而深入的探索。他是牙买加人，在书中，他也提到了自己的家族崛起的故事。<br>&emsp;在《异类》中，他将取得非凡成就的人叫做“异类”，取同类中非凡的含义，然后他开始探究“异类”之所以成功的原因。在普通大众看来，“异类”的成功主要是依靠自身的努力奋斗，其外在因数只不过为之提供了比较有利的条件。但是在这本书中，作者详细解释并描述了各种外界条件对“异类”形成的影响，比如出生年代，家庭背景，机缘巧合等。</p>
<h4 id="分组效应"><a href="#分组效应" class="headerlink" title="分组效应"></a>分组效应</h4><p>&emsp;书中首先提出了选拔机制对运动员成功的影响。作者发现加拿大的冰球运动员的生日大都在一年的前三个月，并且生日在前半年和后半年的比例很是悬殊。结合加拿大冰球选拔制度，作者得出了“分组效应”对运动员成功的影响。加拿大冰球是每个年龄段分一次组，有高手组，也有普通组。如果你在一年的开始出生，在年幼时，由于你比其他人多发育几个月时间，你就有更大的几率被选入高手组；在高手组内，你会受到更严格的训练，所以你会提示得更快；然后每一年你都会累计这样的优势，然后最终产生了巨大的区别。作者又举出了教育领域中类似的例子，出身在前半年的学生的成绩比出生在后半年的学生要好一些，因为他们多发育一段时间，在很小时，会显出一定的小优势，然后因为分组效应，逐渐凸显出来，最终称为“异类”。</p>
<h4 id="一万小时"><a href="#一万小时" class="headerlink" title="一万小时"></a>一万小时</h4><p>&emsp;紧接着，作者提出了<strong>作为领域专家，你必须积累一万小时练习时间</strong>的理论。作者在文中举了很多例子：Sun公司创始人比尔乔伊在密西根大学计算机中心累计了一万小时，小提琴演奏者练习时间的差距，甲壳虫乐队在汉堡的没日没夜的演出累计了一万小时。这些例子，都是为了说明，要成为某一领域的专家，你必须付出的努力和花费的时间。这也就是一般大众眼里的，“异类”的非凡努力。<br>&emsp;但是作者又紧接着提出了对比尔乔伊成功产生巨大影响的环境因素。密西根大学是当时位数不多的具有分时功能计算机的大学，这对练习编程很重要；学校规定学生每月的上机时长，但是碰巧有一个制度漏洞，比尔发现了，从而可以不受时间限制的使用电脑；并且计算机中心是24小时开发的。这些环境因素在那个都是打孔计算机的年代可不多见。</p>
<h4 id="天才之忧"><a href="#天才之忧" class="headerlink" title="天才之忧"></a>天才之忧</h4><p>&emsp;那么智商是否是决定“异类”的重要原因呢？作者在接下来的文章中讲述了两个智商超高的天才的故事：克里斯托弗兰根和奥本海默。兰根智商达到195，远超爱因斯坦的150，但是他却对人类还无贡献（这个智商的人，过得如何已经无法评价他的人生啦，有上天的馈赠，就应该对人类进行馈赠），作者描述了他从小到老年的故事，分析了他在每一个重要关口受到的不利影响，最终，兰根在一个农场里平静的生活，独自研究着自己感兴趣的事务，没有发表过任何科研文章和成果。接着，作者又讲述了奥本海默的故事。对，就是制造原子弹的那个奥本海默。奥本海默在年轻时，也在很多重要关口受到了很多阻碍。比如，他在英国念书时，企图杀死导师，并且人们认为他和共产党有联系。但是他好像每次都能化险为夷，顺利度过难关，最终留名青史。<br>&emsp;作者还提到了一批特殊的人群，“特曼人”，他们是斯坦福心理学专家刘易斯特曼精心挑选出来的智商高于常人的一组小学生，特曼对其中每个人进行长期观察，发现他们长大之后的成就，经济情况大为不同。<br>&emsp;作者由上述三个例子提出了影响“异形”出现的另一个因素：家庭因素。</p>
<h4 id="协同培养-and-自然成长"><a href="#协同培养-and-自然成长" class="headerlink" title="协同培养 and 自然成长"></a>协同培养 and 自然成长</h4><p>&emsp;作者紧接着描述了兰根童年时的遭遇，和其童年生活对他在生活困难关口时作出决定的影响，作为对照，作者又描述了奥本海默所遇到的困难关口，每次奥本海默都从困难关口中顺利脱线，甚至在他试图杀死导师的案件中，他只被判处了缓刑。作者对比了二者的行为，进而退出家庭因素对二者的影响。<br>&emsp;作者比较了中产家庭和低收入家庭对小孩教育的区别，一个叫做“协同培养”，一个是”自然成长“。二者没有好坏之分，实际上，他们各有利弊。但是文中令我颇为感触的是：”权利“意识的形成。</p>
<blockquote>
<p>这些孩子的行为表面他们认为自己有权提出自己的特殊要求，有权参与制度互动。他们愿意在各种情景中更加自如，愿意分享信息，并希望赢得别人的注意…..通过互动来满足自己的偏好。<br>中产阶级家庭的孩子虽然才上四年级，但是已经能站在维护自己利益的基础上行事了。他们要求老师和医生调整办事程序以满足自己的需求<br>作为对照，劳动阶级的孩子的性格被认为是”疏离，疑虑有强迫症“。无论在什么环境下，他们都不知道如何为达到良好愿望”制定策略“。<br> 他的母亲鼓励他（必要时）可以抛开礼节，因为母亲想让儿子学会在权威面前如何维护自己的利益。</p>
</blockquote>
<p>&emsp;然后作者又分析了奥本海默和兰根小时候的教育，丝丝入扣的分析了上述观点的正确性。<br>&emsp;之后，作者又分析了特曼人的例子，当然，其中大多数中产家庭出身的孩子要比低收入家庭出身的孩子要优秀。从而推出阶级优越性对”异类“出现的影响。</p>
<h4 id="你生对时代了吗？"><a href="#你生对时代了吗？" class="headerlink" title="你生对时代了吗？"></a>你生对时代了吗？</h4><p>&emsp;接着作者描述了大律师乔弗洛姆的故事，他是一个犹太人，在上个世纪高等白人把持的律师领域取得了非凡的成就。</p>
<blockquote>
<p>成功人士不可能独自走向成功，他们总是特定地点和特定环境的产物</p>
</blockquote>
<p>&emsp;作者接着列举了于其同一时间段成功的大律师的出身年份，他们大都出身在20世纪30年代早期，而许多非常成功的软件工程师都出生在1955年前后，美国很多大企业家都出生在1835年左右。<br>&emsp;作者描述了出生年份对”异类“成功的原因。当你出生在恰当的年份，你可以在恰当的年龄遇到重大的社会变革和机遇，从而你更容易成功。</p>
<h4 id="文化的影响"><a href="#文化的影响" class="headerlink" title="文化的影响"></a>文化的影响</h4><p>&emsp;书的第二部分主要讲述了文明对”异类“产生的重要影响。其中详细说明了我国南方地区的稻米文化对我国人民性格的影响。除此之外，作者还讲述了韩国的等级意识对其航空事故的影响。</p>
<h4 id="作者自己的例子"><a href="#作者自己的例子" class="headerlink" title="作者自己的例子"></a>作者自己的例子</h4><p>&emsp;在书的最后，作者讲述了他母亲的故事，详细的说明了他们家族从奴隶到中产阶级的故事。其中本书中的所有论点都在他母亲的故事中有所体现。</p>
<h4 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h4><p>&emsp;《异类》并不是一部由教人成功的鸡汤文章组成的书籍，而是一部社会科学性的书籍，它科学的推断并论证取得非凡成功的各种因素。不过，书中提到的一万个小时理论倒是被很多鸡汤文多次引用过。</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://remcarpediem.net/article/6407985a/" data-id="ck6535m8n005a9kseps2jwiq7" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-Android-Scroll详解-一-：基础知识" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/article/1fc40fc1/">Android Scroll详解(一)：基础知识</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/article/1fc40fc1/">
            <time datetime="2016-03-27T10:23:06.000Z" itemprop="datePublished">2016-03-27</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/scroll/">scroll</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>&emsp;在前边的文章中，我们已经对Android触摸事件处理有了大致的了解，并且详细探讨了<code>MotionEvent</code>的相关用法。对之前文章中的知识还不是很了解的同学，请阅读<a href="http://ztelur.github.io/2016/03/16/Android-MotionEvent%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">《Android MotionEvent详解》</a><br>&emsp;今天，我们就来探讨一下Android中界面滚动效果的相关机制，本篇文章主要讲解一下滚动相关的知识点，之后的文章会涉及实际的代码和原理。希望大家阅读完这篇文章之后，能够了解或者掌握一下知识:</p>
<ul>
<li>Android 视图的组成部分</li>
<li><code>mScrollX</code>和<code>mScrollY</code>对视图显示的影响</li>
<li><code>scrollTo</code>和<code>scrollBy</code>的使用</li>
<li><code>invalidate</code>和<code>postInvalidate</code>的区别</li>
</ul>
<h4 id="View的mScrollX和mScrollY"><a href="#View的mScrollX和mScrollY" class="headerlink" title="View的mScrollX和mScrollY"></a>View的mScrollX和mScrollY</h4><p>&emsp;我们都知道，<code>View</code>中有两个重要的成员变量，<code>mScrollX</code>,<code>mScrollY</code>.它们分别代表视图内容(view content)水平方向和竖直方向的滚动距离。我们可以通过<code>setScrollX</code>和<code>setScrollY</code>来个函数来改变它们的值，从而来滚动视图的内容。<br>&emsp;<strong>在这里需要强调的是，<code>mScrollX</code>和<code>mScrollY</code>会导致视图内容(view content)变化,但是不会影响视图背景(background)。</strong><br>&emsp;看到这里同学们或许会有写疑问，视图的内容和背景有什么区别呢？视图还有哪些组成部分呢？<br>&emsp;我们可以从View的<code>draw</code>方法中得知View的组成部分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://grepcode.com/file/repository.grepcode.com/java/ext/com.google.android/android/5.1.1_r1/android/view/View.java#View</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">         ........</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Draw traversal performs several drawing steps which must be executed</span></span><br><span class="line"><span class="comment">         * in the appropriate order:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *      1. Draw the background</span></span><br><span class="line"><span class="comment">         *      2. If necessary, save the canvas' layers to prepare for fading</span></span><br><span class="line"><span class="comment">         *      3. Draw view's content</span></span><br><span class="line"><span class="comment">         *      4. Draw children</span></span><br><span class="line"><span class="comment">         *      5. If necessary, draw the fading edges and restore layers</span></span><br><span class="line"><span class="comment">         *      6. Draw decorations (scrollbars for instance)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 1, draw the background, if needed</span></span><br><span class="line">        <span class="keyword">if</span> (!dirtyOpaque) &#123;</span><br><span class="line">            drawBackground(canvas);</span><br><span class="line">        &#125;</span><br><span class="line">        .......</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 2, save the canvas' layers</span></span><br><span class="line">        .......</span><br><span class="line">        <span class="comment">// Step 3, draw the content</span></span><br><span class="line">        <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 4, draw the children</span></span><br><span class="line">        dispatchDraw(canvas);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Step 5, draw the fade effect and restore layers</span></span><br><span class="line">        .......</span><br><span class="line">        <span class="keyword">if</span> (drawTop) &#123;</span><br><span class="line">            matrix.setScale(<span class="number">1</span>, fadeHeight * topFadeStrength);</span><br><span class="line">            matrix.postTranslate(left, top);</span><br><span class="line">            fade.setLocalMatrix(matrix);</span><br><span class="line">            p.setShader(fade);</span><br><span class="line">            canvas.drawRect(left, top, right, top + length, p);</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">        <span class="comment">// Step 6, draw decorations (scrollbars)</span></span><br><span class="line">        onDrawScrollBars(canvas);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;View显示内容由一下几个部分组成:</p>
<ul>
<li>背景(background)</li>
<li>本身的内容(content)</li>
<li>子视图</li>
<li>边界渐变效果(fade effect),上下左右四个边界都可能会有渐变效果，代码中只显示了上边界的渐变效果绘制。</li>
<li>边框或者装饰效果(decorations),比如滚动条</li>
</ul>
<p>&emsp;举个例子吧，我们都知道在布局文件中，<code>TextView</code>有两个比较重要的属性:<code>background</code>,<code>text</code>。<code>background</code>可以设置TextView的背景，而<code>text</code>则是设置要绘制字体内容。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@drawable/ic_launcher"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">"Test"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;<code>mScrollX</code>和<code>mScrollY</code>对除了本身内容外的部分的绘制都有影响。只是不会影响视图背景的绘制。</p>
<h4 id="滚动的方向性"><a href="#滚动的方向性" class="headerlink" title="滚动的方向性"></a>滚动的方向性</h4><p>&emsp;我们都知道，在Android的视图中，布局相关的数值都是有方向性的，比如<code>mLeft</code>,<code>mTop</code>。</p>
<p><img src="http://7xrxif.com1.z0.glb.clouddn.com/2016327-androidscroll-View%E5%9D%90%E6%A0%87%E8%BD%B4.png" alt="View坐标轴.png"></p>
<p>&emsp;由上图我们可以知道，Android视图坐标的原点在屏幕的左上方，x轴正方向是向右，y轴正方向是向下。<br>&emsp;所以，当你将<code>mLeft</code>和<code>mTop</code>的数值加10并且重绘视图时，视图会向右下移动。<br>&emsp;那么<code>mScrollY</code>和<code>mScrollX</code>也在这样一个坐标域中吗？它们的正方向和<code>mTop</code>和<code>mLeft</code>是一样的吗？是的，它们属于同一个坐标域，方向性相同。<br>&emsp;但是如果你将<code>mScrollX</code>和<code>mScrollY</code>的数值都增大10，然后调用<code>invalidate()</code>重新绘制界面的话，你会发现视图中的内容都向左上角移动啦！<br>&emsp;这是怎么回事呢？从概念上你可以先这样解：<code>mScrollX</code>和<code>mScrollY</code>改变导致View的可视区域的移动，并不是导致View的视图区域的移动。<br>&emsp;View的视图区域相当于无限大的，你可以在<code>onDraw</code>函数中的<code>canvas</code>中绘制任意大的图像，但是你会发现，最终屏幕上显示出来的只会是一部分，因为View自身还有大小概念，也就是<code>measure</code>和<code>layout</code>时，视图会被设置长宽还有界面中位置，这样的话，视图可视区域就被确定啦。<br>&emsp;做一个形象的比喻。View的可视区域就是一面墙上的窗户，View的视图区域就相当于墙后边的优美景色。墙外风光无线，但是你只能看到窗户中的景色。如果窗户变大啦，外边风景不变，你看到的景色就大了一点；如果窗户向右下角移动了一段距离，你就会发现外边的景色好像是向左上角”移动”了一段距离。</p>
<p><img src="http://7xrxif.com1.z0.glb.clouddn.com/2016327-androidscroll-view%20scroll%20example.png" alt="view scroll example.png"></p>
<h4 id="ScrollTo-和-ScrollBy"><a href="#ScrollTo-和-ScrollBy" class="headerlink" title="ScrollTo 和 ScrollBy"></a>ScrollTo 和 ScrollBy</h4><p>&emsp;这两个函数是用来滚动视图的API<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrollTo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mScrollX != x || mScrollY != y) &#123;</span><br><span class="line">        <span class="keyword">int</span> oldX = mScrollX;</span><br><span class="line">        <span class="keyword">int</span> oldY = mScrollY;</span><br><span class="line">        mScrollX = x;</span><br><span class="line">        mScrollY = y;</span><br><span class="line">        invalidateParentCaches();</span><br><span class="line">        onScrollChanged(mScrollX, mScrollY, oldX, oldY);</span><br><span class="line">        <span class="keyword">if</span> (!awakenScrollBars()) &#123;</span><br><span class="line">            postInvalidateOnAnimation();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrollBy</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    scrollTo(mScrollX + x, mScrollY + y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;大家看源代码很容易就理解了二者的作用和区别:<code>scrollTo</code>就是直接改变<code>mScrollX</code>和<code>mScrollY</code>;而<code>scrollBy</code>则是给<code>mScrollX</code>和<code>mScrollY</code>加上增量。</p>
<h4 id="invalidate和postInvalidate"><a href="#invalidate和postInvalidate" class="headerlink" title="invalidate和postInvalidate"></a>invalidate和postInvalidate</h4><p>&emsp;上边这两个函数都是请求视图重新绘制的API,但是二者的使用有些区别。<br>&emsp;<code>invalidate</code>必须在主线程(UI Thread)中调用，而<code>postInvalidate</code>可以在非主线程(Non UI Thread)中调用。<br>&emsp;除此之外，二者还有点小区别。<br>&emsp;调用<code>invalidate</code>时，它会检查上一次请求的UI重绘是否完成，如果没有完成的话，那么它就什么都不做。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invalidateInternal</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b, <span class="keyword">boolean</span> invalidateCache,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> fullInvalidate)</span> </span>&#123;</span><br><span class="line">            .....</span><br><span class="line">         <span class="comment">//DRAWN和HAS_BOUNDS是否被设置为１，说明上一次请求执行的UI绘制已经完成，那么可以再次请求执行</span></span><br><span class="line">        <span class="keyword">if</span> ((mPrivateFlags &amp; (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)) == (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)</span><br><span class="line">                || (invalidateCache &amp;&amp; (mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == PFLAG_DRAWING_CACHE_VALID)</span><br><span class="line">                || (mPrivateFlags &amp; PFLAG_INVALIDATED) != PFLAG_INVALIDATED</span><br><span class="line">                || (fullInvalidate &amp;&amp; isOpaque() != mLastIsOpaque)) &#123;</span><br><span class="line">                 ......</span><br><span class="line">                 <span class="keyword">final</span> AttachInfo ai = mAttachInfo;</span><br><span class="line">                <span class="keyword">final</span> ViewParent p = mParent;</span><br><span class="line">                <span class="keyword">final</span> Rect damage = ai.mTmpInvalRect;</span><br><span class="line">                damage.set(l, t, r, b);</span><br><span class="line">                p.invalidateChild(<span class="keyword">this</span>, damage);<span class="comment">//<span class="doctag">TODO:</span>这是invalidate执行的主体</span></span><br><span class="line">                .....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;而<code>postInvalidate</code>则不会这样，它是向主线程发送个<code>Message</code>，然后<code>handleMessage</code>时，调用了<code>invalidate()</code>函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//View.java</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postInvalidateDelayed</span><span class="params">(<span class="keyword">long</span> delayMilliseconds)</span> </span>&#123;</span><br><span class="line">    ...	              attachInfo.mViewRootImpl.dispatchInvalidateDelayed(<span class="keyword">this</span>, delayMilliseconds);</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ViewRootImpl 发送Message</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchInvalidateDelayed</span><span class="params">(View view, <span class="keyword">long</span> delayMilliseconds)</span> </span>&#123;</span><br><span class="line">        Message msg = mHandler.obtainMessage(MSG_INVALIDATE, view);</span><br><span class="line">        mHandler.sendMessageDelayed(msg, delayMilliseconds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ViewRootImpl 处理Message</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_INVALIDATE:</span><br><span class="line">                ((View) msg.obj).invalidate();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;所以，二者的调用时机还是有区别的，就比如使用<code>Scroller</code>进行视图滚动时，二者的调用就有所不同。</p>
<h4 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h4><p>&emsp;之后还有会两篇博文，一篇是《Android Scroll详解(二)：OverScroller实战》讲解具体代码实现，另外一篇是《Android Scroll详解(三)：Android 绘制过程详解》主要是从滚动角度理解Android绘制过程,请大家多多关注啊。</p>
<blockquote>
<p>参考文章</p>
<p><a href="http://stackoverflow.com/questions/7596370/what-is-the-difference-between-androids-invalidate-and-postinvalidate-metho" target="_blank" rel="noopener">http://stackoverflow.com/questions/7596370/what-is-the-difference-between-androids-invalidate-and-postinvalidate-metho</a></p>
<p><a href="http://www.programering.com/a/MDN3QDNwATQ.html" target="_blank" rel="noopener">http://www.programering.com/a/MDN3QDNwATQ.html</a></p>
<p><a href="http://blog.csdn.net/xiaanming/article/details/17483273" target="_blank" rel="noopener">http://blog.csdn.net/xiaanming/article/details/17483273</a></p>
</blockquote>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://remcarpediem.net/article/1fc40fc1/" data-id="ck6535m6e000k9kserbz779xb" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-Android-MotionEvent详解" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/article/e89a231a/">Android MotionEvent详解</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/article/e89a231a/">
            <time datetime="2016-03-16T05:54:44.000Z" itemprop="datePublished">2016-03-16</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/MotionEvent/">MotionEvent</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>&emsp;在前边几篇博文中（<a href="http://ztelur.github.io/2016/02/11/%E5%9B%BE%E8%A7%A3Android%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E4%B9%8BViewGroup%E7%AF%87/" target="_blank" rel="noopener">《图解Android事件传递之ViewGroup篇》</a>，<a href="http://ztelur.github.io/2016/02/04/%E5%9B%BE%E8%A7%A3Android%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E4%B9%8BView%E7%AF%87/" target="_blank" rel="noopener">《图解Android事件传递之View篇》</a>），我们已经了解了android触摸事件传递机制，接着我们再来研究一下与触摸事件传递相关的几个比较重要的类，比如<code>MotionEvent</code>。我们今天就来详细说明一下这个类的各方面用法。</p>
<h4 id="事件坐标的含义"><a href="#事件坐标的含义" class="headerlink" title="事件坐标的含义"></a>事件坐标的含义</h4><p> 我们都知道，每个触摸事件都代表用户在屏幕上的一个动作，而每个动作必定有其发生的位置。在<code>MotionEvent</code>中就有一系列与标触摸事件发生位置相关的函数：</p>
<ul>
<li><code>getX()</code>和<code>getY()</code>：由这两个函数获得的x,y值是相对的坐标值，相对于消费这个事件的视图的左上点的坐标。</li>
<li><code>getRawX()</code>和<code>getRawY()</code>:有这两个函数获得的x,y值是绝对坐标，是相对于屏幕的。<br> 在之前的文章中，我们曾经分析过事件如何通过层层分发，最终到达消费它的视图手中。其中<code>ViewGroup</code>的<code>dispatchTransformedTouchEvent</code>函数有如下一段代码:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</span><br><span class="line">   event.offsetLocation(offsetX, offsetY);</span><br><span class="line">handled = child.dispatchTouchEvent(event);</span><br><span class="line">event.offsetLocation(-offsetX, -offsetY);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p> 这段代码清晰展示了父视图把事件分发给子视图时，<code>getX()</code>和<code>getY</code>所获得的相关坐标是如何改变的。当父视图处理事件时，上述两个函数获得的相对坐标是相对于父视图的，然后通过上边这段代码，调整了相对坐标的值，让其变为相对于子视图啦。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/623378-f45e4c2e22f0e8aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="绝对坐标和相对坐标示意图"></p>
<h4 id="事件类型"><a href="#事件类型" class="headerlink" title="事件类型"></a>事件类型</h4><p> 涉及<code>MotionEvent</code>使用的代码一般如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> action = MotionEventCompat.getActionMasked(event);</span><br><span class="line"><span class="keyword">switch</span>(action) &#123;</span><br><span class="line">	<span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 这里就引入了关于<code>MotionEvent</code>的一个重要概念，事件类型。事件类型就是指<code>MotionEvent</code>对象所代表的动作。比如说，当你的<strong>一个</strong>手指在屏幕上滑动一下时，系统会产生一系列的触摸事件对象,他们所代表的动作有所不同。有的事件代表你手指<strong>按下</strong>这个动作,有的事件代表你手指在屏幕上<strong>滑动</strong>,还有的事件代表你手指<strong>离开</strong>屏幕。这些事件的事件类型就分别为<code>ACTION_DOWN</code>,<code>ACTION_MOVE</code>,和<code>ACTION_UP</code>。上述这个动作所产生的一系列事件，被称为一个事件流，它包括一个<code>ACTION_DOWN</code>事件，很多个<code>ACTION_MOVE</code>事件，和一个<code>ACTION_UP</code>事件。</p>
<p><img src="http://7xrxif.com1.z0.glb.clouddn.com/2016316-%E5%8D%95%E4%B8%AA%E6%89%8B%E6%8C%87%E5%8A%A8%E4%BD%9C.gif" alt="单个手指动作.gif"></p>
<p> 当然，除了这三个类型外，还有很多不同的事件类型,比如<code>ACTION_CANCEL</code>。它代表当前的手势被取消。要理解这个类型，就必须要了解<code>ViewGroup</code>分发事件的机制。一般来说，如果一个子视图接收了父视图分发给它的<code>ACTION_DOWN</code>事件，那么与<code>ACTION_DOWN</code>事件相关的事件流就都要分发给这个子视图，但是如果父视图希望拦截其中的一些事件，不再继续转发事件给这个子视图的话，那么就需要给子视图一个<code>ACTION_CANCEL</code>事件。<br> 其他的类型会在接下来的博文中一一解释。</p>
<h4 id="Pointer"><a href="#Pointer" class="headerlink" title="Pointer"></a>Pointer</h4><p> 细心的同学会发现，在上一节我描述用户手指在屏幕上滑动的例子时，特地说明了手指的数量为一个。那么当用户两个或者多个手指在屏幕上滑动时，系统又会产生怎样的事件流呢？<br> 为了可以表示多个触摸点的动作，<code>MotionEvent</code>中引入了<code>Pointer</code>的概念，一个pointer就代表一个触摸点，每个pointer都有自己的事件类型，也有自己的横轴坐标值。<strong>一个<code>MotionEvent</code>对象中可能会存储多个pointer的相关信息，每个pointer都会有一个自己的id和index。pointer的id在整个事件流中是不会发生变化的，但是index会发生变化。</strong><br> <code>MotionEvent</code>类中的很多方法都是可以传入一个int值作为参数的，其实传入的就是pointer的index值。比如<code>getX(pointerIndex)</code>和<code>getY(pointerIndex)</code>，此时，它们返回的就是index所代表的触摸点相关事件坐标值。<br> 由于pointer的index值在不同的<code>MotionEvent</code>对象中会发生变化，但是id值却不会变化。所以，当我们要记录一个触摸点的事件流时，就只需要保存其id,然后使用<code>findPointerIndex(int)</code>来获得其index值，然后再获得其他信息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> INVALID_ID = -<span class="number">1</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> mActivePointerId = INVALID_ID;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> mSecondaryPointerId = INVALID_ID;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">float</span> mPrimaryLastX = -<span class="number">1</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">float</span> mPrimaryLastY = -<span class="number">1</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">float</span> mSecondaryLastX = -<span class="number">1</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">float</span> mSecondaryLastY = -<span class="number">1</span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> action = MotionEventCompat.getActionMasked(event);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">               <span class="keyword">int</span> index = event.getActionIndex();</span><br><span class="line">               mActivePointerId = event.getPointerId(index);</span><br><span class="line">               mPrimaryLastX = MotionEventCompat.getX(event,index);</span><br><span class="line">               mPrimaryLastY = MotionEventCompat.getY(event,index);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN:</span><br><span class="line">               index = event.getActionIndex();</span><br><span class="line">               mSecondaryPointerId = event.getPointerId(index);</span><br><span class="line">               mSecondaryLastX = event.getX(index);</span><br><span class="line">               mSecondaryLastY = event.getY(index);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">               index = event.findPointerIndex(mActivePointerId);</span><br><span class="line">               <span class="keyword">int</span> secondaryIndex = MotionEventCompat.findPointerIndex(event,mSecondaryPointerId);</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">float</span> x = MotionEventCompat.getX(event,index);</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">float</span> y = MotionEventCompat.getY(event,index);</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">float</span> secondX = MotionEventCompat.getX(event,secondaryIndex);</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">float</span> secondY = MotionEventCompat.getY(event,secondaryIndex);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP:</span><br><span class="line">               xxxxxx(涉及pointer id的转换，之后的文章会讲解)</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">               mActivePointerId = INVALID_ID;</span><br><span class="line">               mPrimaryLastX =-<span class="number">1</span>;</span><br><span class="line">               mPrimaryLastY = -<span class="number">1</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p> 除了pointer的概念，<code>MotionEvent</code>还引入了两个事件类型：</p>
<ul>
<li><code>ACTION_POINTER_DOWN</code>:代表用户<strong>又</strong>使用一个手指触摸到屏幕上，也就是说，在已经有一个触摸点的情况下，有新出现了一个触摸点。</li>
<li><code>ACTION_POINTER_UP</code>:代表用户的一个手指离开了触摸屏，但是还有其他手指还在触摸屏上。也就是说，在多个触摸点存在的情况下，其中一个触摸点消失了。它与<code>ACTION_UP</code>的区别就是，它是在多个触摸点中的一个触摸点消失时（此时，还有触摸点存在，也就是说用户还有手指触摸屏幕）产生，而<code>ACTION_UP</code>可以说是最后一个触摸点消失时产生。</li>
</ul>
<p> 那么，用户先两个手指先后接触屏幕，同时滑动，然后在先后离开这一套动作所产生的事件流是什么样的呢？<br> 它所产生的事件流如下：</p>
<ul>
<li>先产生一个<code>ACTION_DOWN</code>事件，代表用户的第一个手指接触到了屏幕。</li>
<li>再产生一个<code>ACTION_POINTER_DOWN</code>事件，代表用户的第二个手指接触到了屏幕。</li>
<li>很多的<code>ACTION_MOVE</code>事件，但是在这些<code>MotionEvent</code>对象中，都保存着两个触摸点滑动的信息，相关的代码我们会在文章的最后进行演示。</li>
<li>一个<code>ACTION_POINTER_UP</code>事件，代表用户的一个手指离开了屏幕。</li>
<li>如果用户剩下的手指还在滑动时，就会产生很多<code>ACTION_MOVE</code>事件。</li>
<li>一个<code>ACTION_UP</code>事件，代表用户的最后一个手指离开了屏幕</li>
</ul>
<p><img src="http://7xrxif.com1.z0.glb.clouddn.com/2016316-%E4%B8%A4%E4%B8%AA%E6%89%8B%E6%8C%87%E7%9A%84%E5%8A%A8%E4%BD%9C.gif" alt="两个手指的动作.gif"></p>
<h4 id="getAction-和-getActionMasked"><a href="#getAction-和-getActionMasked" class="headerlink" title="getAction 和 getActionMasked"></a>getAction 和 getActionMasked</h4><p>&emsp;这一段之前有问题，多谢马同学指出其中的错误。<br> 看到文章开头那段代码的同学可能会有点疑问：好像在很多代码里，大家都是通过<code>getAction</code>获得事件类型的，那么它和<code>getActionMasked</code>又有什么不同呢？<br> 从上一节我们可以得知，一个<code>MotionEvent</code>对象中可以包含多个触摸点的事件。当<code>MotionEvent</code>对象只包含一个触摸点的事件时，上边两个函数的结果是相同的，但是当包含多个触摸点时，二者的结果就不同啦。<br> <code>getAction</code>获得的int值是由pointer的index值和事件类型值组合而成的，而<code>getActionWithMasked</code>则只返回事件的类型值<br> 举个例子（注:假设了int中不同位所代表的含义，可能不是例子所中的前8位代表index,后8位代表事件类型）:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getAction() returns 0x0105.</span><br><span class="line">getActionMasked() will return 0x0005</span><br><span class="line">其中0x0100就是pointer的index值。</span><br></pre></td></tr></table></figure></p>
<p> 一般来说，<code>(getAction() &amp; ACTION_POINTER_INDEX_MASK)&gt;&gt;ACTION_POINTER_INDEX_SHIFT</code>就获得了pointer的index,等同于<code>getActionIndex</code>函数;<code>getAction()&amp; ACTION_MASK</code>就获得了pointer的事件类型，等同于<code>getActionMasked</code>函数。</p>
<h4 id="批处理"><a href="#批处理" class="headerlink" title="批处理"></a>批处理</h4><p> 为了效率，Android系统在处理<code>ACTION_MOVE</code>事件时会将连续的几个多触点移动事件打包到一个<code>MotionEvent</code>对象中。我们可以通过<code>getX(int)</code>和<code>getY(int)</code>来获得最近发生的一个触摸点事件的坐标，然后使用<code>getHistorical(int,int)</code>和<code>getHistorical(int,int)</code>来获得时间稍早的触点事件的坐标，二者是发生时间先后的关系。所以，我们应该先处理通过<code>getHistoricalXX</code>相关函数获得的事件信息，然后在处理当前的事件信息。<br> 下边就是Android Guide中相关的例子:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printSamples</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> historySize = ev.getHistorySize();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pointerCount = ev.getPointerCount();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; historySize; h++) &#123;</span><br><span class="line">        System.out.printf(<span class="string">"At time %d:"</span>, ev.getHistoricalEventTime(h));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; pointerCount; p++) &#123;</span><br><span class="line">            System.out.printf(<span class="string">"  pointer %d: (%f,%f)"</span>,</span><br><span class="line">                ev.getPointerId(p), ev.getHistoricalX(p, h), ev.getHistoricalY(p, h));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.printf(<span class="string">"At time %d:"</span>, ev.getEventTime());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; pointerCount; p++) &#123;</span><br><span class="line">        System.out.printf(<span class="string">"  pointer %d: (%f,%f)"</span>,</span><br><span class="line">            ev.getPointerId(p), ev.getX(p), ev.getY(p));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h4><p> 之后的博文会继续分析关于触摸处理的几个比较重要的类，比如<code>OverScroller</code>和<code>EdgeEffect</code>;然后会是一篇关于滑动手势处理代码分析的文章。请大家继续关注。</p>
<p>–<br>参考文章:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/11960861/what-causes-a-motionevent-action-cancel-in-android" target="_blank" rel="noopener">何时产生EVENT_CANCEL事件</a></li>
<li><a href="http://stackoverflow.com/questions/13710967/android-multitouch-and-getactionmasked" target="_blank" rel="noopener">getAction和getActionMasked的区别</a></li>
<li><a href="http://developer.android.com/intl/zh-cn/reference/android/view/MotionEvent.html" target="_blank" rel="noopener">MotionEvent的API</a></li>
<li><a href="http://developer.android.com/intl/zh-cn/training/gestures/index.html" target="_blank" rel="noopener">Android Gesture Guide</a></li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://remcarpediem.net/article/e89a231a/" data-id="ck6535m6b000f9ksem9b431lw" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-译-使用注解处理器生成代码-3-生成源代码" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/article/bc9d3ce1/">[译]使用注解处理器生成代码-3 生成源代码</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/article/bc9d3ce1/">
            <time datetime="2016-03-07T13:51:20.000Z" itemprop="datePublished">2016-03-07</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/注解/">注解</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p> 本博文原文地址<a href="https://deors.wordpress.com/2011/10/31/annotation-generators/" target="_blank" rel="noopener">摸我</a><br> 本篇博文是关于使用注解处理器生成java代码系列的第三篇也是最后一篇文章。在第一篇（在<a href="http://www.jianshu.com/p/ed2a755fc053" target="_blank" rel="noopener">这里</a>）中，我们介绍了注解和其一般用法。在第二篇（在<a href="http://www.jianshu.com/p/d294bf008bec" target="_blank" rel="noopener">这里</a>）中，我们介绍了注解处理器，如何构造并且使用它。 在本篇博文中，我们将想你展示如何使用注解处理器来生成源代码。</p>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p> 生成源代码很简单。生成正确的源代码却很难。优雅高效的去生成正确的代码是很麻烦的任务。<br> 幸运的是，Model-Driver Engineering(1)为我们提供了基于已经证明有效的过程和工具的成熟的方法理论。</p>
<h4 id="MDE-的-Model-和-Meta-model"><a href="#MDE-的-Model-和-Meta-model" class="headerlink" title="MDE 的 Model 和 Meta-model"></a>MDE 的 Model 和 Meta-model</h4><p> 在讨论如何使用注解处理器生成源代码之前，有几个相关的概念我们要实现讲明，那就是<strong>models</strong> 和 <strong>meta-model</strong><br> MDE的理论基础之一为抽象的构造(construction of abstractions)。我们将软件系统在不同的层次和细节上使用不同的方法进行建模。当软件在一个抽象层次上被建模完成之后，我们就开始对下一个抽象层次进行建模，知道建立一个完备的，可部署的产品。<br> 在这种理论环境下，一个model 就是我们用来在某一抽象层级上表示软件系统的抽象。<br> meta-model就是我们用来写model的规则，你可以理解为model的纲要或者语法。</p>
<h4 id="使用注解处理器生成源代码"><a href="#使用注解处理器生成源代码" class="headerlink" title="使用注解处理器生成源代码"></a>使用注解处理器生成源代码</h4><p> 由上述描述可见，注解是定义model和meta-model的好方法，注解类型(Annotation Type)充当meta-model的角色，标注在一段代码上的注解来提供model。<br> 我们可以使用这个model来生成配置文件或者从现有代码中生成新代码。比如，通过注解bean来生成远程代理或者数据访问对象。<br> 这个方法的核心就是使用注解处理器。注解处理器可以读取在源代码中发现的注解，并且对注解做任何想做的事情-比如，打开文件，写文件，等等。</p>
<h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><p> 我们在第二篇博文中曾经说过，每个处理器都可以通过处理环境(processing environment)对象获得一些有用的工具，Filter就是其中之一。<br> <strong>javax.annotation.processing.Filer</strong>接口定义了一些关于创建源文件，类文件和一般资源的方法。通过使用<code>Filter</code>我们可以使用正确的文件目录，并且确保不会丢失文件系统中的生成的文件或者资源。<br> 下面这个例子可以显示如何在注解处理器中生成代码。生成的类名就是被注解的类名加上BeanInfo的后缀：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (e.getKind() == ElementKind.CLASS) &#123;     </span><br><span class="line">  TypeElement classElement = (TypeElement) e;</span><br><span class="line">  PackageElement packageElement =         </span><br><span class="line">        (PackageElement) classElement.getEnclosingElement();  </span><br><span class="line">  JavaFileObject jfo =  processingEnv.getFiler().</span><br><span class="line">        createSourceFile(classElement.getQualifiedName() </span><br><span class="line">        + <span class="string">"BeanInfo"</span>);     </span><br><span class="line"></span><br><span class="line">  BufferedWriter bw = <span class="keyword">new</span> BufferedWriter(jfo.openWriter());       </span><br><span class="line">  bw.append(<span class="string">"package "</span>);      </span><br><span class="line">  bw.append(packageElement.getQualifiedName());     </span><br><span class="line">  bw.append(<span class="string">";"</span>);     </span><br><span class="line">  bw.newLine();     </span><br><span class="line">  bw.newLine();     </span><br><span class="line">  <span class="comment">// rest of generated class contents</span></span><br></pre></td></tr></table></figure></p>
<p>####不要这样生成代码<br> 上边这个例子十分简单，有趣但是很混乱。<br> 我们把从注解中读取信息的逻辑和写生成的源文件的逻辑混一起拉。<br> 按照上述那种方式很难写出简洁的代码，如果当我们遇到一些更加复杂的逻辑时，就更难啦。<br> 我们需要一个更加优雅的实现方式：- 将不同逻辑分离- 使用模版来让代码生成更加简单<br> 让我们看看使用Apache的Velocity构造代码生成器的例子吧。</p>
<h4 id="Velocity简介"><a href="#Velocity简介" class="headerlink" title="Velocity简介"></a>Velocity简介</h4><p> <a href="http://velocity.apache.org/" target="_blank" rel="noopener">Velocity</a> 是通过混合模版和java类的数据来生成各类文本文件的模版引擎。 <code>Velocity</code>可以在<code>MVC</code>框架中渲染视图或者在<code>xml</code>传输数据时替代<code>XSLT</code><br> <code>Velocity</code>有它自己的语言叫做Velocity Template Language（VTL）。在VTL中，我们可以定义变量，控制流，迭代和获取java对象中的数据。<br> 下面就是<code>Velocity</code>模版的一个片段:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">**#foreach($field in $fields)**     </span><br><span class="line">/**      </span><br><span class="line">* Returns the $&#123;field.simpleName&#125; property descriptor.      </span><br><span class="line">*      </span><br><span class="line">* @return the property descriptor      </span><br><span class="line">*/     </span><br><span class="line">public PropertyDescriptor </span><br><span class="line">$&#123;field.simpleName&#125;PropertyDescriptor() &#123;         </span><br><span class="line">  PropertyDescriptor theDescriptor = null;         </span><br><span class="line">  return theDescriptor;     </span><br><span class="line">&#125; </span><br><span class="line">#end </span><br><span class="line">#foreach($method in $methods)     </span><br><span class="line">/**      </span><br><span class="line">* Returns the </span><br><span class="line">*</span><br><span class="line">*$&#123;method.simpleName&#125;**() method descriptor.      </span><br><span class="line">*      </span><br><span class="line">* @return the method descriptor      </span><br><span class="line">*/     </span><br><span class="line">public MethodDescriptor</span><br><span class="line">$&#123;method.simpleName&#125;MethodDescriptor() &#123;         </span><br><span class="line">  MethodDescriptor descriptor = null;</span><br></pre></td></tr></table></figure></p>
<p> 正如你所看到的，VTL十分简单并且易于理解。<code>#foreach($field in $fields)</code>代表对对象集合的迭代；<code>${method.simpleName}</code>则是打印数据信息。</p>
<h4 id="Velocity代码生成器"><a href="#Velocity代码生成器" class="headerlink" title="Velocity代码生成器"></a>Velocity代码生成器</h4><p> 既然我们决定使用<code>Veloctiy</code>来增强我们的代码生成器，那么我们就要重新进行设计：</p>
<ul>
<li>设计用来生成代码的模版</li>
<li>注解处理器会从<code>round environment</code>中读取被注解元素，并且将其保存到对象中，比如保存成员变量，方法，或者类，包的表.</li>
<li>注解处理器需要初始化<code>Velocity</code>相关上下文- 注解处理器需要加载<code>Velocity</code>模版- 注解处理器会创建源文件(使用<code>Filer</code>)并且传递一个<code>Writer</code>给<code>Velocity</code>模版</li>
<li><code>Veloctiy</code>引擎生成源代码<br> 使用这个方案，我们会发现处理器和生成器相关的代码是清晰，良好组织并且易于理解和维护。<br> 让我们一步一步的来实现这个方案吧。<br>####步骤一:实现一个模版<br> 为了简单，我们并不会展示<code>BeanInfo</code>生成器的全部代码，而是只展示我们注解处理器需要使用的一部分成员变量和方法。<br> 我们先创建一个名为beaninfovm的文件，并且放置在Maven的<code>src/main/resource</code>下。文件内容如下:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> $&#123;packageName&#125;;</span><br><span class="line"><span class="keyword">import</span> java.beans.MethodDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.beans.ParameterDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.beans.PropertyDescriptor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> $</span>&#123;className&#125;BeanInfo </span><br><span class="line">        extends java.beans.SimpleBeanInfo </span><br><span class="line">&#123; </span><br><span class="line">  <span class="comment">/** * Gets the bean class object. </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> the bean class </span></span><br><span class="line"><span class="comment">  */</span> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Class <span class="title">getBeanClass</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> $&#123;packageName&#125;.$&#123;className&#125;.class; </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Gets the bean class name. </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> the bean class name </span></span><br><span class="line"><span class="comment">  */</span> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getBeanClassName</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="string">"$&#123;packageName&#125;.$&#123;className&#125;"</span>; </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Finds the right method by comparing name &amp; number of parameters in the class </span></span><br><span class="line"><span class="comment">  * method list. </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> classObject the class object </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> methodName the method name </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> parameterCount the number of parameters </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> the method if found, &lt;code&gt;null&lt;/code&gt; otherwise       </span></span><br><span class="line"><span class="comment">  */</span> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Method <span class="title">findMethod</span><span class="params">(Class classObject, String methodName, <span class="keyword">int</span> parameterCount)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">try</span> &#123; </span><br><span class="line">      <span class="comment">// since this method attempts to find a method by getting all     </span></span><br><span class="line">      <span class="comment">// methods from the class, this method should only be called if </span></span><br><span class="line">      <span class="comment">// getMethod cannot find the method </span></span><br><span class="line">      Method[] methods = classObject.getMethods(); </span><br><span class="line">      <span class="keyword">for</span> (Method method : methods) &#123; </span><br><span class="line">        <span class="keyword">if</span> (method.getParameterTypes().length ==</span><br><span class="line">            parameterCount &amp;&amp;method.getName().</span><br><span class="line">                equals(methodName)) &#123; </span><br><span class="line">          <span class="keyword">return</span> method; </span><br><span class="line">        &#125; </span><br><span class="line">      &#125; </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123; </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">    &#125;</span><br><span class="line">#foreach($field in $fields) </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Returns the $&#123;field.simpleName&#125; property descriptor. </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> the property descriptor </span></span><br><span class="line"><span class="comment">  */</span> </span><br><span class="line"><span class="keyword">public</span> PropertyDescriptor </span><br><span class="line">$&#123;field.simpleName&#125;PropertyDescriptor() &#123; </span><br><span class="line">   PropertyDescriptor theDescriptor = <span class="keyword">null</span>; </span><br><span class="line">   <span class="keyword">return</span> theDescriptor; </span><br><span class="line">&#125;</span><br><span class="line">#end#foreach($method in $methods) </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">  * Returns the $&#123;method.simpleName&#125;() method descriptor. </span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> the method descriptor </span></span><br><span class="line"><span class="comment">  */</span> </span><br><span class="line"><span class="keyword">public</span> MethodDescriptor $&#123;method.simpleName&#125;MethodDescriptor() &#123; </span><br><span class="line">   MethodDescriptor descriptor = <span class="keyword">null</span>; </span><br><span class="line">   Method method = <span class="keyword">null</span>; </span><br><span class="line">   <span class="keyword">try</span> &#123; </span><br><span class="line">    <span class="comment">// finds the method using getMethod with parameter types </span></span><br><span class="line">    <span class="comment">// TODO parameterize parameter types </span></span><br><span class="line">      Class[] parameterTypes =  </span><br><span class="line">        &#123;java.beans.PropertyChangeListener.class&#125;; </span><br><span class="line">     method=getBeanClass().</span><br><span class="line">         getMethod(<span class="string">"$&#123;method.simpleName&#125;"</span>, parameterTypes); </span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123; </span><br><span class="line">    <span class="comment">// alternative: use findMethod </span></span><br><span class="line">    <span class="comment">// TODO parameterize number of parameters </span></span><br><span class="line">    method = findMethod(getBeanClass(), <span class="string">"$&#123;method.simpleName&#125;"</span>, <span class="number">1</span>); </span><br><span class="line"> &#125; </span><br><span class="line">  <span class="keyword">try</span> &#123; </span><br><span class="line">    <span class="comment">// creates the method descriptor with parameter descriptors     </span></span><br><span class="line">    <span class="comment">// TODO parameterize parameter descriptors     </span></span><br><span class="line">    ParameterDescriptor parameterDescriptor1 = <span class="keyword">new</span>   </span><br><span class="line">        ParameterDescriptor();     </span><br><span class="line">    parameterDescriptor1.setName(<span class="string">"listener"</span>); </span><br><span class="line">    parameterDescriptor1.setDisplayName(<span class="string">"listener"</span>); </span><br><span class="line">    ParameterDescriptor[] parameterDescriptors = </span><br><span class="line">      &#123;parameterDescriptor1&#125;; </span><br><span class="line">    descriptor = <span class="keyword">new</span> MethodDescriptor(method,   </span><br><span class="line">        parameterDescriptors); </span><br><span class="line">   &#125; <span class="keyword">catch</span> (Throwable t) &#123; </span><br><span class="line">      <span class="comment">// alternative: create a plain method descriptor </span></span><br><span class="line">      descriptor = <span class="keyword">new</span> MethodDescriptor(method); </span><br><span class="line">   &#125; </span><br><span class="line">  <span class="comment">// TODO parameterize descriptor properties   </span></span><br><span class="line">   descriptor.setDisplayName(<span class="string">"$&#123;method.simpleName&#125;    </span></span><br><span class="line"><span class="string">        (java.beans.PropertyChangeListener)"</span>); </span><br><span class="line">   descriptor.setShortDescription(<span class="string">"Adds a property change </span></span><br><span class="line"><span class="string">        listener."</span>); </span><br><span class="line">   descriptor.setExpert(<span class="keyword">false</span>); </span><br><span class="line">   descriptor.setHidden(<span class="keyword">false</span>); </span><br><span class="line">   descriptor.setValue(<span class="string">"preferred"</span>, <span class="keyword">false</span>); </span><br><span class="line">   <span class="keyword">return</span> descriptor; </span><br><span class="line"> &#125;</span><br><span class="line">#end</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p> 为了使用上述的模版，我们需要向<code>Velocity</code>传递下边这些信息:</p>
<ul>
<li><code>packageName</code>:生成类的全限定包名</li>
<li><code>className</code>:生成类名</li>
<li><code>field</code>:生成类中的成员变量集合；每个成员变量我们需要以下信息:<ul>
<li><code>simpleName</code>:成员变量名 - <code>type</code>:成员变量的类型(在本例中并未使用)</li>
<li><code>description</code>:自我解释型信息(在本例中并未使用) </li>
<li>…</li>
</ul>
</li>
<li><p><code>method</code>:生成类中函数的集合；每个函数我们需要一下信息：       </p>
<ul>
<li><code>simpleName</code>:函数名 </li>
<li><code>arguments</code>:函数的参数(在本例中并未使用) </li>
<li><code>returnType</code>: 函数返回值类型(在本例中并未使用) </li>
<li><code>description</code>:自我解释性信息(在本例中并未使用) </li>
<li>…</li>
</ul>
</li>
</ul>
<p> 所有的这些信息都会从源文件中的注解中获得，并保存到<code>JavaBean</code>中，再传递给<code>Velocity</code>。</p>
<h4 id="步骤二-注解处理器读取信息"><a href="#步骤二-注解处理器读取信息" class="headerlink" title="步骤二:注解处理器读取信息"></a>步骤二:注解处理器读取信息</h4><p> 让我们来实现一个注解处理器，并且注解它支持处理<code>BeanInfo</code>注解类型，相关原理请查看第二篇博文。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SupportedAnnotationTypes</span>(<span class="string">"example.annotations.beaninfo.BeanInfo"</span>)</span><br><span class="line"><span class="meta">@SupportedSourceVersion</span>(SourceVersion.RELEASE_6)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanInfoProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br></pre></td></tr></table></figure></p>
<p> 注解处理器需要从注解和源文件中提取。你可以使用<code>JavaBean</code>来保存你需要的信息。但是在这个例子中，我们将使用<code>javax.lang.model.element</code>,因为我们不计划传递给<code>Velocity</code>过多信息:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  String packageName = <span class="keyword">null</span>; </span><br><span class="line">  Map&lt;String, VariableElement&gt; fields = <span class="keyword">new</span> HashMap&lt;String,     </span><br><span class="line">    VariableElement&gt;(); </span><br><span class="line">  Map&lt;String, ExecutableElement&gt; methods = <span class="keyword">new</span> </span><br><span class="line">    HashMap&lt;String, ExecutableElement&gt;(); </span><br><span class="line">  <span class="keyword">for</span> (Element e : roundEnv.</span><br><span class="line">      getElementsAnnotatedWith(BeanInfo.class)) &#123; </span><br><span class="line">    <span class="keyword">if</span> (e.getKind() == ElementKind.CLASS) &#123; </span><br><span class="line">      TypeElement classElement = (TypeElement) e; </span><br><span class="line">      PackageElement packageElement = (PackageElement) </span><br><span class="line">        classElement.getEnclosingElement();   </span><br><span class="line">      processingEnv.getMessager().printMessage( </span><br><span class="line">            Diagnostic.Kind.NOTE, <span class="string">"annotated class: "</span> + </span><br><span class="line">            classElement.getQualifiedName(), e); </span><br><span class="line">      fqClassName = classElement.getQualifiedName().</span><br><span class="line">                toString(); </span><br><span class="line">      className =  classElement.getSimpleName().toString(); </span><br><span class="line">      packageName = packageElement.getQualifiedName().</span><br><span class="line">                toString(); </span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.getKind() == ElementKind.FIELD) &#123; </span><br><span class="line">      VariableElement varElement = (VariableElement) e;   </span><br><span class="line">      processingEnv.getMessager().printMessage( </span><br><span class="line">        Diagnostic.Kind.NOTE, <span class="string">"annotated field: "</span> + </span><br><span class="line">        varElement.getSimpleName(), e); </span><br><span class="line">      fields.put(varElement.getSimpleName().toString(),       </span><br><span class="line">        varElement); </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.getKind() == ElementKind.METHOD) &#123; </span><br><span class="line">      ExecutableElement exeElement = (ExecutableElement) e;     </span><br><span class="line">      processingEnv.getMessager().printMessage( </span><br><span class="line">        Diagnostic.Kind.NOTE, <span class="string">"annotated method: "</span> + </span><br><span class="line">        exeElement.getSimpleName(), e); </span><br><span class="line">      methods.put(exeElement.getSimpleName().toString(),   </span><br><span class="line">        exeElement); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤三-初始化Velocity并且加载模版"><a href="#步骤三-初始化Velocity并且加载模版" class="headerlink" title="步骤三:初始化Velocity并且加载模版"></a>步骤三:初始化<code>Velocity</code>并且加载模版</h4><p> 下边的代码片段展示了如何初始化<code>Velocity</code>并且加载模版<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fqClassName != <span class="keyword">null</span>) &#123; </span><br><span class="line">  Properties props = <span class="keyword">new</span> Properties(); </span><br><span class="line">  URL url = <span class="keyword">this</span>.getClass().getClassLoader().</span><br><span class="line">        getResource(<span class="string">"velocity.properties"</span>); </span><br><span class="line">  props.load(url.openStream()); </span><br><span class="line">  VelocityEngine ve = <span class="keyword">new</span> VelocityEngine(props); </span><br><span class="line">  ve.init(); </span><br><span class="line">  VelocityContext vc = <span class="keyword">new</span> VelocityContext(); </span><br><span class="line">  vc.put(<span class="string">"classNameassName); </span></span><br><span class="line"><span class="string">  vc.put("</span>packageNameckageName); </span><br><span class="line">  vc.put(<span class="string">"fieldselds); </span></span><br><span class="line"><span class="string">  vc.put("</span>methodsthods); </span><br><span class="line">  Template vt = ve.getTemplate(<span class="string">"beaninfo.vm"</span>);</span><br></pre></td></tr></table></figure></p>
<p> <code>Velocity</code>的配置文件，应该命名为<code>Velocity.properties</code>,并放置在<code>src/main/resources</code>文件夹下。配置文件的内容如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">runtime.log.logsystem.class = org.apache.velocity.runtime.log.SystemLogChute</span><br><span class="line">resource.loader = classpath</span><br><span class="line">classpath.resource.loader.class = org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader</span><br></pre></td></tr></table></figure></p>
<p> 这些属性配置了<code>Velocity</code>的日志和寻找模版的类路径。</p>
<h4 id="步骤四：创建新的文件并且生成代码"><a href="#步骤四：创建新的文件并且生成代码" class="headerlink" title="步骤四：创建新的文件并且生成代码"></a>步骤四：创建新的文件并且生成代码</h4><p> 最后，我们建立新的代码文件并以这个文件为目标运行模版。下边的代码片段展示了如何如何去做上述操作:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">JavaFileObject jfo = processingEnv.getFiler().createSourceFile</span><br><span class="line">    ( fqClassName + <span class="string">"BeanInfo"</span>); </span><br><span class="line">processingEnv.getMessager().printMessage( </span><br><span class="line">    Diagnostic.Kind.NOTE, <span class="string">"creating source file: "</span> + jfo.toUri()); </span><br><span class="line">Writer writer = jfo.openWriter(); </span><br><span class="line">processingEnv.getMessager().printMessage(   </span><br><span class="line">    Diagnostic.Kind.NOTE, <span class="string">"applying velocity template: "</span> + </span><br><span class="line">    vt.getName());</span><br><span class="line">vt.merge(vc, writer); </span><br><span class="line">writer.close();</span><br></pre></td></tr></table></figure></p>
<h4 id="步骤五：打包并运行"><a href="#步骤五：打包并运行" class="headerlink" title="步骤五：打包并运行"></a>步骤五：打包并运行</h4><p> 最终，注册注解处理器（可以回想一下在第二篇博文中的服务配置相关内容），打包处理器并且在命令行，eclipse和Maven构建项目时使用它。<br> 假设下边就是需要处理的类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example.velocity.client;</span><br><span class="line"><span class="keyword">import</span> example.annotations.beaninfo.BeanInfo;</span><br><span class="line"><span class="meta">@BeanInfo</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Article</span> </span>&#123; </span><br><span class="line">  <span class="meta">@BeanInfo</span> </span><br><span class="line">  <span class="keyword">private</span> String id; </span><br><span class="line">  <span class="meta">@BeanInfo</span> </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> department; </span><br><span class="line">  <span class="meta">@BeanInfo</span> </span><br><span class="line">  <span class="keyword">private</span> String status; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Article</span><span class="params">()</span> </span>&#123; <span class="keyword">super</span>(); &#125; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> id; &#125; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123; <span class="keyword">this</span>.id = id; &#125; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDepartment</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> department; </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDepartment</span><span class="params">(<span class="keyword">int</span> department)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">this</span>.department = department; </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getStatus</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> status; &#125; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStatus</span><span class="params">(String status)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">this</span>.status = status; </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="meta">@BeanInfo</span> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">activate</span><span class="params">()</span> </span>&#123; setStatus(<span class="string">"active"</span>); &#125; </span><br><span class="line">  <span class="meta">@BeanInfo</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deactivate</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    setStatus(<span class="string">"inactive"</span>); </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p> 当我们使用命令行执行编译任务时，我们在终端上看到被注解标注的元素被找到并且BeanInfo类被生成。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Article.java:6: Note: annotated class: </span><br><span class="line">example.annotations.velocity.client.Article</span><br><span class="line">public class Article &#123; </span><br><span class="line">  ^</span><br><span class="line">Article.java:9: Note: annotated field: id </span><br><span class="line">  private String id; </span><br><span class="line">    ^</span><br><span class="line">Article.java:12: Note: annotated field: department </span><br><span class="line">  private int department; </span><br><span class="line">    ^</span><br><span class="line">Article.java:15: Note: annotated field: status </span><br><span class="line">  private String status; </span><br><span class="line">    ^</span><br><span class="line">Article.java:53: Note: annotated method: activate </span><br><span class="line">  public void <span class="function"><span class="title">activate</span></span>() &#123; </span><br><span class="line">    ^</span><br><span class="line">Article.java:59: Note: annotated method: deactivate </span><br><span class="line">  public void <span class="function"><span class="title">deactivate</span></span>() &#123; </span><br><span class="line">    ^ </span><br><span class="line">Note: creating <span class="built_in">source</span> file: file:/c:/projects/example.annotations.velocity.client/src/main/java/example/annotations/velocity/client/ArticleBeanInfo.java</span><br><span class="line">Note: applying velocity template: beaninfo.vm</span><br><span class="line">Note: example\annotations\velocity\client\ArticleBeanInfo.java uses unchecked or unsafe operations.</span><br><span class="line">Note: Recompile with -Xlint:unchecked <span class="keyword">for</span> details.</span><br></pre></td></tr></table></figure></p>
<p> 检查相应的文件夹我们会发现<code>BeanInfo</code>类文件被创建。任务完成！</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p> 在这个系列文章中，我们学习了如何使用Java6中的注解处理器框架生成源代码：</p>
<ul>
<li>我们学习了注解和注解类型的概念和他们的基本用法</li>
<li>我们学习了注解处理器的概念，还有如何编写，以及从不同工具运行它。</li>
<li>我们大致讨论了一下<code>Model-Drive Engineer</code>和代码生成。</li>
<li>我们展示了如何使用注解处理器生成代码</li>
<li>我们学习了如何使用<code>Velocity</code>来创建优雅的，强大的，可维护的基于注解处理器的代码生成器。<br> 现在是时候实现你自己的项目去啦。<br>-<br>(1) 如何你想详细了解<code>MDE</code>,请查看<a href="http://en.wikipedia.org/wiki/Model-driven_engineering" target="_blank" rel="noopener">这篇文件</a><br>(2) <code>Filter</code>的API文档可以在<a href="http://download.oracle.com/javase/6/docs/api/javax/annotation/processing/Filer.html" target="_blank" rel="noopener">这里</a>进行查看</li>
</ul>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://remcarpediem.net/article/bc9d3ce1/" data-id="ck6535m9k007o9ksexpfabsgg" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-2016年，计划目录" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/article/47a9c0e4/">2016年，计划目录</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/article/47a9c0e4/">
            <time datetime="2016-03-05T01:34:18.000Z" itemprop="datePublished">2016-03-05</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/plan/">plan</a>
    </div>

                        
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>&emsp;建立一个计划目录，记录一下１６年的计划和实现情况,进行不定时的更新。</p>
<h3 id="计划清单"><a href="#计划清单" class="headerlink" title="计划清单"></a><strong>计划清单</strong></h3><h4 id="英语学习"><a href="#英语学习" class="headerlink" title="英语学习"></a><strong>英语学习</strong></h4><h5 id="ESL-Pod-暂停"><a href="#ESL-Pod-暂停" class="headerlink" title="ESL_Pod [暂停]"></a>ESL_Pod <strong>[暂停]</strong></h5><p>《English as a second language podcast presents – Introduction to the United States》总共100课。还没有开始，从3月5日开始</p>
<h5 id="扇贝"><a href="#扇贝" class="headerlink" title="扇贝　"></a>扇贝　</h5><ul>
<li>单词 :在背英语单词书，5518词，完成进度8.10%　 计划每天５０词，并且阅读两篇文章 </li>
</ul>
<h5 id="新概念英语-从16-4月开始的"><a href="#新概念英语-从16-4月开始的" class="headerlink" title="新概念英语 [从16.4月开始的]"></a>新概念英语 <strong>[从16.4月开始的]</strong></h5><p>每天一篇小文章背诵。</p>
<h4 id="Android学习"><a href="#Android学习" class="headerlink" title="Android学习"></a><strong>Android学习</strong></h4><h5 id="Android-Annotation-Processor学习"><a href="#Android-Annotation-Processor学习" class="headerlink" title="Android Annotation Processor学习"></a>Android Annotation Processor学习</h5><ul>
<li>三篇文章翻译</li>
<li>Butterknife源码分析</li>
<li>javapoet and 其他的一些class文件修改框架  </li>
</ul>
<h5 id="View相关知识学习-完成，16-3-16-4-23"><a href="#View相关知识学习-完成，16-3-16-4-23" class="headerlink" title="View相关知识学习[完成，16.3~16.4.23]"></a>View相关知识学习<strong>[完成，16.3~16.4.23]</strong></h5><ul>
<li>事件传递处理和各种手势处理</li>
<li>View的measure,layout,draw<br>总结:</li>
<li><a href="http://ztelur.github.io/2016/03/27/Android-Scroll%E8%AF%A6%E8%A7%A3-%E4%B8%80-%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" target="_blank" rel="noopener">《Android Scroll详解(一)：基础知识》</a></li>
<li><a href="http://ztelur.github.io/2016/03/16/Android-MotionEvent%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">《Android MotionEvent详解》</a></li>
<li><a href="http://ztelur.github.io/2016/02/11/%E5%9B%BE%E8%A7%A3Android%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E4%B9%8BViewGroup%E7%AF%87/" target="_blank" rel="noopener">《图解Android事件传递之ViewGroup篇》</a></li>
<li><a href="http://ztelur.github.io/2016/02/04/%E5%9B%BE%E8%A7%A3Android%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E4%B9%8BView%E7%AF%87/" target="_blank" rel="noopener">《图解Android事件传递之View篇》</a>。</li>
<li><a href="http://ztelur.github.io/2016/04/07/Android-Scroll%E8%AF%A6%E8%A7%A3-%E4%BA%8C-%EF%BC%9AOverScroller%E5%AE%9E%E6%88%98/" target="_blank" rel="noopener">《Android Scroll详解(二)：OverScroller实战》</a></li>
<li><a href="http://ztelur.github.io/2016/04/17/Android%E8%A7%86%E5%9B%BE%E6%9E%B6%E6%9E%84%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">《Android视图架构详解》</a></li>
<li><a href="http://ztelur.github.io/2016/04/21/Android-Scroll%E8%AF%A6%E8%A7%A3-%E4%B8%89-%EF%BC%9AAndroid-%E7%BB%98%E5%88%B6%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">《Android Scroll详解(三)：Android 绘制过程详解》</a></li>
</ul>
<h5 id="Android动画学习-从16-4-23到5-19-暂时暂停"><a href="#Android动画学习-从16-4-23到5-19-暂时暂停" class="headerlink" title="Android动画学习 从16.4.23到5.19 暂时暂停"></a>Android动画学习 <strong>从16.4.23到5.19 暂时暂停</strong></h5><ul>
<li><a href="https://segmentfault.com/a/1190000004354609" target="_blank" rel="noopener">指导文章</a></li>
<li><a href="http://ztelur.github.io/2016/05/09/Property-Animation%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3-%E4%B8%80/" target="_blank" rel="noopener">Property Animation框架详解(一)</a></li>
<li><a href="http://ztelur.github.io/2016/07/15/%E8%87%AA%E5%AE%9A%E4%B9%89Switch%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">自定义Switch过程详解</a><h5 id="Android-Service-进程间通讯-未进行，中断"><a href="#Android-Service-进程间通讯-未进行，中断" class="headerlink" title="Android Service+进程间通讯 未进行，中断"></a>Android Service+进程间通讯 <strong>未进行，中断</strong></h5><h5 id="Android-TomatoGo开发-正在进行从10-1日开始"><a href="#Android-TomatoGo开发-正在进行从10-1日开始" class="headerlink" title="Android TomatoGo开发 正在进行从10.1日开始"></a>Android TomatoGo开发 <strong>正在进行从10.1日开始</strong></h5></li>
</ul>
<h5 id="Android优化学习-正在进行从12-13日开始"><a href="#Android优化学习-正在进行从12-13日开始" class="headerlink" title="Android优化学习　正在进行从12.13日开始"></a>Android优化学习　<strong>正在进行从12.13日开始</strong></h5><ul>
<li>启动优化</li>
<li>内存优化</li>
<li>各类工具使用</li>
<li>基础知识</li>
</ul>
<h4 id="前端-正在进行从12-13日进行"><a href="#前端-正在进行从12-13日进行" class="headerlink" title="前端　正在进行从12.13日进行"></a><strong>前端</strong>　<strong>正在进行从12.13日进行</strong></h4><ul>
<li>《js权威指南》 800页</li>
<li>《css scret》 300页</li>
<li>react 网页代码学习</li>
</ul>
<h5 id="Hexo-自定义主题"><a href="#Hexo-自定义主题" class="headerlink" title="Hexo 自定义主题"></a>Hexo 自定义主题</h5><h4 id="要阅读的书籍"><a href="#要阅读的书籍" class="headerlink" title="要阅读的书籍"></a><strong>要阅读的书籍</strong></h4><h5 id="技术方面书籍"><a href="#技术方面书籍" class="headerlink" title="技术方面书籍"></a>技术方面书籍</h5><ul>
<li>《计算机解释和构造》,开始时间3.30</li>
<li>《Professional javascript for web Developers.3rd》 一天10页左右<h5 id="其他书籍"><a href="#其他书籍" class="headerlink" title="其他书籍"></a>其他书籍</h5></li>
<li>《从美国看世界》,预计时间<strong>2个星期</strong>，<strong>开始时间3月5日</strong>,<strong>弃坑</strong></li>
<li>《穷查理的历书》,预计时间<strong>1个星期</strong>,<strong>开始时间3月14日</strong></li>
<li><p>《美丽新世界》开始世界4.23<br>###<strong>Update 2016.3.14</strong></p>
<h5 id="ESL-Pod"><a href="#ESL-Pod" class="headerlink" title="ESL_Pod"></a>ESL_Pod</h5><p>《English as a second language podcast presents – Introduction to the United States》总共100课。已经完成8课</p>
<h4 id="要阅读的书籍-1"><a href="#要阅读的书籍-1" class="headerlink" title="要阅读的书籍"></a>要阅读的书籍</h4></li>
<li><p>《从美国看世界》：阅读1星期，只读了一半左右，主要讲述美国经济大萧条时期的经济制度，美国政府政策和帝国主义根源等问题，不是很感兴趣</p>
</li>
<li>《计算机解释和构造》开始阅读</li>
<li>《穷查理的历书》开始阅读</li>
<li>《美丽的新世界》完成</li>
<li>《月亮和六便士》完成</li>
<li>《自控力》正在进行从5.1日开始</li>
<li>《金阁寺》<strong>正在进行从12.13日开始</strong></li>
</ul>
<p>###<strong>Update 2016.4.5</strong></p>
<h4 id="要阅读的书籍-2"><a href="#要阅读的书籍-2" class="headerlink" title="要阅读的书籍"></a>要阅读的书籍</h4><ul>
<li>《计算机解释和构造》完成第一章阅读，希望进行一下总结</li>
<li>《异类 不一样的成功启示录》：清明放假一口气看完，主要讲述了“异类”成功的原因。其中的一万小时定律很是吸引人。读后感：<a href="http://ztelur.github.io/2016/04/05/%E3%80%8A%E5%BC%82%E7%B1%BB-%E4%B8%8D%E4%B8%80%E6%A0%B7%E6%88%90%E5%8A%9F%E7%9A%84%E5%90%AF%E7%A4%BA%E5%BD%95%E3%80%8B%E8%AF%BB%E5%90%8E%E6%84%9F/" target="_blank" rel="noopener">《异类-不一样成功的启示录》读后感</a></li>
<li>《自控力》：读一读，感觉最近懒癌又犯了。一周读一章的节奏。</li>
</ul>
<h3 id="Android-学习"><a href="#Android-学习" class="headerlink" title="Android 学习"></a>Android 学习</h3><h5 id="View相关知识学习"><a href="#View相关知识学习" class="headerlink" title="View相关知识学习"></a>View相关知识学习</h5><ul>
<li>事件传递处理和各种手势处理:<a href="http://ztelur.github.io/2016/03/27/Android-Scroll%E8%AF%A6%E8%A7%A3-%E4%B8%80-%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" target="_blank" rel="noopener">《Android Scroll详解(一)：基础知识》</a>，<br><a href="http://ztelur.github.io/2016/03/16/Android-MotionEvent%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">《Android MotionEvent详解》</a>，<a href="http://ztelur.github.io/2016/02/11/%E5%9B%BE%E8%A7%A3Android%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E4%B9%8BViewGroup%E7%AF%87/" target="_blank" rel="noopener">《图解Android事件传递之ViewGroup篇》</a>，<a href="http://ztelur.github.io/2016/02/04/%E5%9B%BE%E8%A7%A3Android%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E4%B9%8BView%E7%AF%87/" target="_blank" rel="noopener">《图解Android事件传递之View篇》</a>。</li>
<li>View的measure,layout,draw</li>
</ul>
<h3 id="英语"><a href="#英语" class="headerlink" title="英语"></a>英语</h3><h4 id="扇贝-1"><a href="#扇贝-1" class="headerlink" title="扇贝"></a>扇贝</h4><ul>
<li>打卡：90天</li>
<li>单词：2016考研英语词汇大纲 5518词，学习进度13.80%</li>
</ul>
<h3 id="Udpate-2015-4-23"><a href="#Udpate-2015-4-23" class="headerlink" title=" Udpate 2015.4.23"></a><strong> Udpate 2015.4.23</strong></h3><h3 id="要阅读的书籍-3"><a href="#要阅读的书籍-3" class="headerlink" title="要阅读的书籍"></a>要阅读的书籍</h3><ul>
<li>《SICP》第二章，阅读第一章时没有及时做习题，导致很多内容都忘记了，第二章时要立即做习题</li>
<li>《自控力》放弃阅读….不太喜欢读这一类的书籍</li>
<li>《美丽新世界》，之前读过《1984》,然后被推荐了这本书</li>
</ul>
<h3 id="Android学习-1"><a href="#Android学习-1" class="headerlink" title="Android学习"></a>Android学习</h3><h4 id="View相关知识学习-1"><a href="#View相关知识学习-1" class="headerlink" title="View相关知识学习"></a>View相关知识学习</h4><p>学习完结</p>
<ul>
<li><a href="http://ztelur.github.io/2016/04/07/Android-Scroll%E8%AF%A6%E8%A7%A3-%E4%BA%8C-%EF%BC%9AOverScroller%E5%AE%9E%E6%88%98/" target="_blank" rel="noopener">Android Scroll详解(二)：OverScroller实战</a></li>
<li><a href="http://ztelur.github.io/2016/04/17/Android%E8%A7%86%E5%9B%BE%E6%9E%B6%E6%9E%84%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">Android视图架构详解</a></li>
<li><a href="http://ztelur.github.io/2016/04/21/Android-Scroll%E8%AF%A6%E8%A7%A3-%E4%B8%89-%EF%BC%9AAndroid-%E7%BB%98%E5%88%B6%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">Android Scroll详解(三)：Android 绘制过程详解</a></li>
</ul>
<p>###＃ Android Animation<br>开始学习</p>
<h3 id="英语-1"><a href="#英语-1" class="headerlink" title="英语"></a>英语</h3><h4 id="扇贝-2"><a href="#扇贝-2" class="headerlink" title="扇贝"></a>扇贝</h4><ul>
<li>打卡：108天</li>
<li>单词：2016考研英语词汇大纲 5518词，学习进度17.63%</li>
</ul>
<h4 id="新概念英语"><a href="#新概念英语" class="headerlink" title="新概念英语"></a>新概念英语</h4><p>一天一篇小文章背诵，已经背诵了８篇了。</p>
<h3 id="Udpate-2016-5-19"><a href="#Udpate-2016-5-19" class="headerlink" title=" Udpate 2016.5.19"></a><strong> Udpate 2016.5.19</strong></h3><h3 id="要阅读的书籍-4"><a href="#要阅读的书籍-4" class="headerlink" title="要阅读的书籍"></a>要阅读的书籍</h3><ul>
<li>《SICP》已经看到77页，边做题边看，进度比较慢，但是感觉收获很多。</li>
<li>《美丽的新世界》，《月亮和六便士》都已经看完了，希望写一篇《月亮和六便士》的读后感！！！</li>
<li>正在读《自控力》</li>
</ul>
<h3 id="Android学习-2"><a href="#Android学习-2" class="headerlink" title="Android学习"></a>Android学习</h3><p>####Android Animation<br>暂时只有这一篇总结<br><a href="http://ztelur.github.io/2016/05/09/Property-Animation%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3-%E4%B8%80/" target="_blank" rel="noopener">Property Animation框架详解(一)</a></p>
<h4 id="Service和进程间通讯"><a href="#Service和进程间通讯" class="headerlink" title="Service和进程间通讯"></a>Service和进程间通讯</h4><p>正在进行</p>
<h3 id="英语-2"><a href="#英语-2" class="headerlink" title="英语"></a>英语</h3><h4 id="扇贝-3"><a href="#扇贝-3" class="headerlink" title="扇贝"></a>扇贝</h4><ul>
<li>打卡：122天</li>
<li>单词：2016考研英语词汇大纲 5518词，学习进度19.84%</li>
</ul>
<h4 id="新概念英语-1"><a href="#新概念英语-1" class="headerlink" title="新概念英语"></a>新概念英语</h4><p>一天一篇小文章背诵，已经背诵了10篇了。</p>
<h4 id="Update-2016-7-6"><a href="#Update-2016-7-6" class="headerlink" title=" Update 2016.7.6"></a><strong> Update 2016.7.6</strong></h4><p>决定转变编程研究方向，学习后端开发。由于Java基础比较好，所以先通过Java web开发来熟悉后端开发，并且学习Python编程。</p>
<h3 id="要阅读的书籍-5"><a href="#要阅读的书籍-5" class="headerlink" title="要阅读的书籍"></a>要阅读的书籍</h3><ul>
<li>《局外人》，《西西弗神话》。加缪短片小说。荒诞！ <strong>已经读完</strong></li>
<li>《Head First Servlet and JSP》  <strong>在读</strong><h3 id="英语-3"><a href="#英语-3" class="headerlink" title="英语"></a>英语</h3><h4 id="扇贝-4"><a href="#扇贝-4" class="headerlink" title="扇贝"></a>扇贝</h4>继续扇贝学习，中间断了半个月啦。</li>
</ul>
<h3 id="Update-2016-8-1"><a href="#Update-2016-8-1" class="headerlink" title=" Update 2016.8.1 "></a><strong> Update 2016.8.1 </strong></h3><h3 id="要阅读的书籍-6"><a href="#要阅读的书籍-6" class="headerlink" title="要阅读的书籍"></a>要阅读的书籍</h3><ul>
<li>《Professional javascript for web Developers.3rd》 一天10页左右</li>
<li>《SICP》暂时停止</li>
</ul>
<h3 id="Android-学习-1"><a href="#Android-学习-1" class="headerlink" title="Android 学习"></a>Android 学习</h3><h4 id="Android-Animation"><a href="#Android-Animation" class="headerlink" title="Android Animation"></a>Android Animation</h4><p>新做一篇<br><a href="http://ztelur.github.io/2016/07/15/%E8%87%AA%E5%AE%9A%E4%B9%89Switch%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3/" target="_blank" rel="noopener">自定义Switch过程详解</a></p>
<h4 id="Span-and-Drawable-框架-开始"><a href="#Span-and-Drawable-框架-开始" class="headerlink" title="Span and Drawable 框架　开始"></a>Span and Drawable 框架　开始</h4><h3 id="英语-4"><a href="#英语-4" class="headerlink" title="英语"></a>英语</h3><h4 id="扇贝-5"><a href="#扇贝-5" class="headerlink" title="扇贝"></a>扇贝</h4><ul>
<li>打卡 150</li>
<li>单词: 进度 23.9%</li>
</ul>
<h3 id="Update-2016-10-1"><a href="#Update-2016-10-1" class="headerlink" title=" Update 2016.10.1 "></a><strong> Update 2016.10.1 </strong></h3><h3 id="要阅读的书籍-7"><a href="#要阅读的书籍-7" class="headerlink" title="要阅读的书籍"></a>要阅读的书籍</h3><ul>
<li>《Professional javascript for web Developers.3rd》 一天10页左右</li>
</ul>
<h3 id="Android-学习-2"><a href="#Android-学习-2" class="headerlink" title="Android 学习"></a>Android 学习</h3><h4 id="TomatoGO应用开发"><a href="#TomatoGO应用开发" class="headerlink" title="TomatoGO应用开发"></a>TomatoGO应用开发</h4><h3 id="英语-5"><a href="#英语-5" class="headerlink" title="英语"></a>英语</h3><h4 id="扇贝-6"><a href="#扇贝-6" class="headerlink" title="扇贝"></a>扇贝</h4><ul>
<li>打卡 170</li>
</ul>
<h3 id="update-2016-12-12"><a href="#update-2016-12-12" class="headerlink" title="update 2016.12.12 "></a><strong>update 2016.12.12 </strong></h3>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://remcarpediem.net/article/47a9c0e4/" data-id="ck6535m5w00039kse6cgjhopf" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/page/6/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/8/">Next &raquo;</a>
    </nav>
</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <!-- <div class="item-thumbnail">
                            <a href="/article/d5009955/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/java-persistent/">java persistent</a></p>
                            <p class="item-title"><a href="/article/d5009955/" class="title">Java 数据持久化系列之池化技术</a></p>
                            <p class="item-date"><time datetime="2020-02-02T13:48:17.000Z" itemprop="datePublished">2020-02-02</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- <div class="item-thumbnail">
                            <a href="/article/75dc863d/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/plan/">plan</a></p>
                            <p class="item-title"><a href="/article/75dc863d/" class="title">2020年，计划目录</a></p>
                            <p class="item-date"><time datetime="2020-01-27T05:00:09.000Z" itemprop="datePublished">2020-01-27</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- <div class="item-thumbnail">
                            <a href="/article/24b8edbf/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Redis/">Redis</a></p>
                            <p class="item-title"><a href="/article/24b8edbf/" class="title">Redis Cluster 的数据分片机制</a></p>
                            <p class="item-date"><time datetime="2019-12-21T13:24:26.000Z" itemprop="datePublished">2019-12-21</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- <div class="item-thumbnail">
                            <a href="/article/1dd72ef8/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Redis/">Redis</a></p>
                            <p class="item-title"><a href="/article/1dd72ef8/" class="title">Redis 命令执行过程(下)</a></p>
                            <p class="item-date"><time datetime="2019-12-11T15:09:14.000Z" itemprop="datePublished">2019-12-11</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <!-- <div class="item-thumbnail">
                            <a href="/article/4cc1fb9/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div> -->
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Redis/">Redis</a></p>
                            <p class="item-title"><a href="/article/4cc1fb9/" class="title">Redis 命令执行过程(上)</a></p>
                            <p class="item-date"><time datetime="2019-12-09T14:25:54.000Z" itemprop="datePublished">2019-12-09</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SICP/">SICP</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java-persistent/">java persistent</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/plan/">plan</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/分布式/">分布式</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/并发/">并发</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂记/">杂记</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计/">设计</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a><span class="archive-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/AOP/" style="font-size: 15px;">AOP</a> <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/Animation/" style="font-size: 10px;">Animation</a> <a href="/tags/Cookie/" style="font-size: 10px;">Cookie</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/GSON/" style="font-size: 10px;">GSON</a> <a href="/tags/JSON/" style="font-size: 10px;">JSON</a> <a href="/tags/JUC/" style="font-size: 20px;">JUC</a> <a href="/tags/Jenkins/" style="font-size: 10px;">Jenkins</a> <a href="/tags/Material-Design/" style="font-size: 10px;">Material Design</a> <a href="/tags/MotionEvent/" style="font-size: 10px;">MotionEvent</a> <a href="/tags/Netty/" style="font-size: 20px;">Netty</a> <a href="/tags/OkHttp/" style="font-size: 15px;">OkHttp</a> <a href="/tags/Raft/" style="font-size: 10px;">Raft</a> <a href="/tags/React-Native/" style="font-size: 10px;">React Native</a> <a href="/tags/RxJava/" style="font-size: 10px;">RxJava</a> <a href="/tags/SICP/" style="font-size: 10px;">SICP</a> <a href="/tags/Shader/" style="font-size: 10px;">Shader</a> <a href="/tags/Span/" style="font-size: 15px;">Span</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/TCP/" style="font-size: 15px;">TCP</a> <a href="/tags/TCP-IP/" style="font-size: 20px;">TCP/IP</a> <a href="/tags/View/" style="font-size: 15px;">View</a> <a href="/tags/View-Architecture/" style="font-size: 10px;">View Architecture</a> <a href="/tags/ViewRoot/" style="font-size: 10px;">ViewRoot</a> <a href="/tags/Window机制/" style="font-size: 10px;">Window机制</a> <a href="/tags/animation/" style="font-size: 10px;">animation</a> <a href="/tags/cas/" style="font-size: 10px;">cas</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/draw/" style="font-size: 10px;">draw</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/filesystem/" style="font-size: 10px;">filesystem</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/kubernetes/" style="font-size: 10px;">kubernetes</a> <a href="/tags/persistent/" style="font-size: 15px;">persistent</a> <a href="/tags/redis/" style="font-size: 20px;">redis</a> <a href="/tags/scroll/" style="font-size: 15px;">scroll</a> <a href="/tags/spring-cloud/" style="font-size: 10px;">spring-cloud</a> <a href="/tags/事件传递/" style="font-size: 15px;">事件传递</a> <a href="/tags/依赖注入/" style="font-size: 10px;">依赖注入</a> <a href="/tags/分布式/" style="font-size: 10px;">分布式</a> <a href="/tags/动态编程/" style="font-size: 10px;">动态编程</a> <a href="/tags/反射/" style="font-size: 10px;">反射</a> <a href="/tags/图像处理/" style="font-size: 10px;">图像处理</a> <a href="/tags/实习/" style="font-size: 10px;">实习</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/工具-Linux/" style="font-size: 10px;">工具, Linux</a> <a href="/tags/市场/" style="font-size: 10px;">市场</a> <a href="/tags/并发/" style="font-size: 10px;">并发</a> <a href="/tags/思维/" style="font-size: 10px;">思维</a> <a href="/tags/数据结构/" style="font-size: 10px;">数据结构</a> <a href="/tags/文件系统/" style="font-size: 10px;">文件系统</a> <a href="/tags/框架/" style="font-size: 10px;">框架</a> <a href="/tags/注解/" style="font-size: 20px;">注解</a> <a href="/tags/第三方库/" style="font-size: 15px;">第三方库</a> <a href="/tags/算法/" style="font-size: 20px;">算法</a> <a href="/tags/读书/" style="font-size: 10px;">读书</a> <a href="/tags/贪婪算法/" style="font-size: 10px;">贪婪算法</a> <a href="/tags/软件设计/" style="font-size: 10px;">软件设计</a> <a href="/tags/锁/" style="font-size: 10px;">锁</a> <a href="/tags/限流/" style="font-size: 15px;">限流</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://www.blueskykong.com/">aoho blog</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2020 历小冰<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
	<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
	<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
	<script>
		var gitment = new Gitment({
			owner: 'lexburner',
			repo: 'lexburner.github.io',
			oauth: {
				client_id: 'd5fc3e1150477a0d433d',
				client_secret: 'aa94acd5f130281051b9e703c19b4c6d878e90c4',
			},
		})
		gitment.render('commentContainer')
	</script>
	



    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>